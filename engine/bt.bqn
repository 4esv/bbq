# bbq â€” BQN Based Quant
# engine/bt.bqn â€” backtesting engine

core â† â€¢Import "core.bqn"

# Re-export core (strategies only import bt.bqn)
âŸ¨eps, tdy, Split, Pstd, Wilder,
 Load, Validate, Align,
 MA, EMA, WMA, Std, RSI, MACD, ATR, Mom, ROC, Stoch, BB, OBV, VWAP, AD, RMax, RMin,
 Cross, CrossDown, Mask, Fill, Thresh, ThreshDown, HoldâŸ© â‡ core

# â”€â”€ Simulation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Step _Sim initâ€¿obs â†’ positions
# Step: state ğ”½ observation â†’ new_state (first element = position)
_Sim â‡ {
  Fn â† ğ”½
  initâ€¿obs â† ğ•©
  state â† init
  {
    state â†© state Fn ğ•©
    âŠ‘state
  }Â¨ obs
}

# â”€â”€ Backtest Core â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Ret prices â†’ simple returns (1 shorter than input)
Ret â‡ {(1â†“ğ•©-Â»ğ•©) Ã· 1â†“Â»ğ•©}

# LogRet prices â†’ log returns (1 shorter than input)
LogRet â‡ {1â†“ â‹†â¼ ğ•©Ã·Â»ğ•©}

# pos Run ret â†’ strategy returns
Run â‡ Ã—

# pos RunOHLC data â†’ strategy returns using open-to-open execution
# Assumes positions decided at end of bar i, fills at open of bar i+1
RunOHLC â‡ {
  pos â† ğ•¨ â‹„ d â† ğ•©
  opret â† ((1â†“d.open) - Â¯1â†“d.open) Ã· Â¯1â†“d.open
  (Â¯1â†“pos) Ã— opret
}

# rate Cost pos â†’ transaction cost array
Cost â‡ {ğ•¨ Ã— |-âŸœÂ»ğ•©}

# Equity ret â†’ equity curve starting at 1
Equity â‡ {Ã—`1+ğ•©}

# â”€â”€ Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Internal: drawdown series from returns
DdSeries â† {
  eq â† Ã—`1+ğ•©
  mx â† âŒˆ`eq
  (eq-mx)Ã·mx
}

# Annualized Sharpe ratio (Rf=0, sample std N-1)
Sharpe â‡ {
  n â† â‰ ğ•©
  m â† (+Â´ğ•©)Ã·n
  s â† âˆš(+Â´(ğ•©-m)â‹†2)Ã·(n-1)âŒˆ1
  (âˆštdy) Ã— m Ã· sâŒˆeps
}

# Sortino ratio (downside deviation, population semi-variance N)
Sortino â‡ {
  m â† (+Â´Ã·â‰ )ğ•©
  dd â† 0âŒŠğ•©
  ds â† âˆš(+Â´ddâ‹†2)Ã·â‰ ğ•©
  (âˆštdy) Ã— m Ã· dsâŒˆeps
}

# Maximum drawdown (negative number)
MaxDD â‡ {âŒŠÂ´ DdSeries ğ•©}

# Longest drawdown duration (bars)
MaxDDDur â‡ {âŒˆÂ´0{ğ•©Ã—1+ğ•¨}`(DdSeries ğ•©)<0}

# Total cumulative return
TotalRet â‡ {Â¯1+(Â¯1âŠ‘Ã—`1+ğ•©)}

# Compound annual growth rate (252 days/yr)
# NOTE: clamp terminal equity to eps â€” negative equity makes fractional exponent undefined
CAGR â‡ {((epsâŒˆÂ¯1âŠ‘Ã—`1+ğ•©)â‹†tdyÃ·â‰ ğ•©)-1}

# Annualized volatility
AnnVol â‡ {(Pstd ğ•©)Ã—âˆštdy}

# Calmar ratio (CAGR / |MaxDD|)
Calmar â‡ {(CAGR ğ•©) Ã· (|MaxDD ğ•©)âŒˆeps}

# Win rate (positive returns / non-zero returns, excludes flat days)
WinRate â‡ {
  active â† ğ•©â‰ 0
  (+Â´ğ•©>0) Ã· (+Â´active)âŒˆ1
}

# Profit factor (gross profit / gross loss)
ProfitFactor â‡ {
  (+Â´(ğ•©>0)Ã—ğ•©) Ã· (|+Â´(ğ•©<0)Ã—ğ•©)âŒˆeps
}

# Average winning return
AvgWin â‡ {wâ†(ğ•©>0)/ğ•© â‹„ (+Â´w)Ã·(â‰ w)âŒˆ1}

# Average losing return (negative number)
AvgLoss â‡ {lâ†(ğ•©<0)/ğ•© â‹„ (+Â´l)Ã·(â‰ l)âŒˆ1}

# Expectancy (mean return per active bar)
Expectancy â‡ {aâ†(ğ•©â‰ 0)/ğ•© â‹„ (+Â´a)Ã·(â‰ a)âŒˆ1}

# Trades â€” count position changes (takes positions)
Trades â‡ {+Â´(Â»ğ•©)â‰ ğ•©}

# Time in market (takes positions)
TimeIn â‡ {(+Â´ğ•©â‰ 0)Ã·â‰ ğ•©}

# Exposure â€” alias for TimeIn
Exposure â‡ TimeIn

# Skewness (third standardized moment)
Skew â‡ {
  m â† (+Â´Ã·â‰ )ğ•©
  s â† Pstd ğ•©
  (+Â´((ğ•©-m)Ã·sâŒˆeps)â‹†3) Ã· â‰ ğ•©
}

# Excess kurtosis (fourth standardized moment minus 3)
Kurt â‡ {
  m â† (+Â´Ã·â‰ )ğ•©
  s â† Pstd ğ•©
  Â¯3 + (+Â´((ğ•©-m)Ã·sâŒˆeps)â‹†4) Ã· â‰ ğ•©
}

# â”€â”€ Portfolio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# weights PortRun assets â€” weighted portfolio returns
# assets: list of posâ€¿ret pairs, weights: per-asset allocation (must sum to 1)
PortRun â‡ {
  ! 1eÂ¯6 > |1-+Â´ğ•¨
  strats â† {pâ€¿r â† ğ•© â‹„ pÃ—r}Â¨ ğ•©
  +Â´ ğ•¨ Ã— strats
}

# rates PortCost positions â€” combined transaction costs
# positions: list of pos arrays, rates: per-asset cost rate
PortCost â‡ {+Â´ ğ•¨ {ğ•¨ Ã— |-âŸœÂ»ğ•©}Â¨ ğ•©}

# PortEquity â€” alias for Equity (clarity for portfolio context)
PortEquity â‡ Equity

# nameâ€¿cpos PortReport assetsâ€¿cret
# assets: list of tickerâ€¿strat_ret pairs, cret: combined portfolio returns
PortReport â‡ {
  nameâ€¿cpos â† ğ•¨
  assetsâ€¿cret â† ğ•©

  â€¢Out "â•â•â• " âˆ¾ name âˆ¾ " â•â•â•"

  # Per-asset one-liners
  {
    tickerâ€¿sr â† ğ•©
    â€¢Out "  " âˆ¾ (8 Pad ticker) âˆ¾ "Sharpe: " âˆ¾ (Rd Sharpe sr) âˆ¾ "  Total: " âˆ¾ (Pct TotalRet sr) âˆ¾ "  MaxDD: " âˆ¾ (Pct MaxDD sr)
  }Â¨ assets

  â€¢Out ""
  nameâ€¿cpos Report cretâ€¿cret
}

# â”€â”€ Reporting helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Format percentage with sign
Pct â‡ {
  v â† âŒŠ0.5+1000Ã—|ğ•©
  d â† â€¢Fmt 10|v
  w â† â€¢Fmt âŒŠvÃ·10
  ((ğ•©<0)/"-") âˆ¾ ((ğ•©>0)/"+") âˆ¾ w âˆ¾ "." âˆ¾ d âˆ¾ "%"
}

# Round to 2 decimal places with sign
Rd â‡ {
  v â† âŒŠ0.5+100Ã—|ğ•©
  d â† â€¢Fmt 100|v
  d â†© ((2>â‰ d)/"0") âˆ¾ d
  w â† â€¢Fmt âŒŠvÃ·100
  ((ğ•©<0)/"-") âˆ¾ w âˆ¾ "." âˆ¾ d
}

# Right-pad string to width
Pad â‡ {(ğ•¨âŒˆâ‰ ğ•©)â†‘ğ•©}

# â”€â”€ Reporting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# nameâ€¿pos Report strat_retâ€¿bh_ret â€” print formatted summary
Report â‡ {
  nameâ€¿pos â† ğ•¨
  stratâ€¿bh â† ğ•©

  # Format a metric line: label, strategy value, benchmark value
  Line â† {lâ€¿svâ€¿bv:
    (16 Pad l) âˆ¾ (10 Pad sv) âˆ¾ "  (B&H: " âˆ¾ bv âˆ¾ ")"
  }

  # Format a solo metric line (no benchmark)
  Solo â† {lâ€¿sv:
    (16 Pad l) âˆ¾ sv
  }

  paired â† âŸ¨
    "Total:"â€¿(Pct TotalRet strat)â€¿(Pct TotalRet bh)
    "CAGR:"â€¿(Pct CAGR strat)â€¿(Pct CAGR bh)
    "Sharpe:"â€¿(Rd Sharpe strat)â€¿(Rd Sharpe bh)
    "Sortino:"â€¿(Rd Sortino strat)â€¿(Rd Sortino bh)
    "MaxDD:"â€¿(Pct MaxDD strat)â€¿(Pct MaxDD bh)
    "MaxDD Dur:"â€¿(â€¢Fmt MaxDDDur strat)â€¿(â€¢Fmt MaxDDDur bh)
    "Calmar:"â€¿(Rd Calmar strat)â€¿(Rd Calmar bh)
    "Volatility:"â€¿(Pct AnnVol strat)â€¿(Pct AnnVol bh)
  âŸ©

  singles â† âŸ¨
    "Win Rate:"â€¿(Pct WinRate strat)
    "Profit Factor:"â€¿(Rd ProfitFactor strat)
    "Expectancy:"â€¿(Pct Expectancy strat)
    "Trades:"â€¿(â€¢Fmt Trades pos)
    "Time In:"â€¿(Pct TimeIn pos)
    "Skew:"â€¿(Rd Skew strat)
    "Kurtosis:"â€¿(Rd Kurt strat)
  âŸ©

  â€¢Out "â•â•â• " âˆ¾ name âˆ¾ " â•â•â•"
  â€¢OutÂ¨ LineÂ¨ paired
  â€¢OutÂ¨ SoloÂ¨ singles

  # Verdict
  sharpe â† Sharpe strat
  maxdd â† MaxDD strat
  verdict â† {
    maxdd<Â¯0.40 ? "Max drawdown > 40%, reconsider";
    sharpeâ‰¥1.0  ? "Worth paper trading";
    sharpeâ‰¥0.5  ? "Has potential, needs work";
    "Not worth pursuing"
  }
  â€¢Out "â”€â”€â”€"
  â€¢Out "Verdict: " âˆ¾ verdict
}
