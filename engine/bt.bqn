# bbq â€” BQN Backtesting for Quant
# engine/bt.bqn â€” all public API

# â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# NOTE: yfinance CSV format: 3 header lines, then Date,Close,High,Low,Open,Volume
Split â† (âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŸœ','âŠ¸âŠ”

Load â‡ {
  lines â† â€¢FLines ğ•©
  rows â† SplitÂ¨ 3â†“lines
  dates â‡ 0âŠ¸âŠ‘Â¨ rows
  close â‡ â€¢ParseFloatÂ¨ 1âŠ¸âŠ‘Â¨ rows
  high  â‡ â€¢ParseFloatÂ¨ 2âŠ¸âŠ‘Â¨ rows
  low   â‡ â€¢ParseFloatÂ¨ 3âŠ¸âŠ‘Â¨ rows
  open  â‡ â€¢ParseFloatÂ¨ 4âŠ¸âŠ‘Â¨ rows
  vol   â‡ â€¢ParseFloatÂ¨ 5âŠ¸âŠ‘Â¨ rows
}

# â”€â”€ Indicators â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Wilder smoothing (EMA with Î±=1/n). Used by RSI and ATR.
Wilder â† {aâ†Ã·ğ•¨ â‹„ (âŠ‘ğ•©){(aÃ—ğ•©)+(1-a)Ã—ğ•¨}`ğ•©}

# n RMax prices â€” rolling maximum
RMax â‡ {âŒˆÂ´Ë˜ ğ•¨â†•ğ•©}

# n RMin prices â€” rolling minimum
RMin â‡ {âŒŠÂ´Ë˜ ğ•¨â†•ğ•©}

# n MA prices â€” simple moving average, O(n) via prefix-sum
MA â‡ {
  cs â† 0âˆ¾+`ğ•©
  ((ğ•¨â†“cs) - ((-ğ•¨)â†“cs)) Ã· ğ•¨
}

# n EMA prices â€” exponential moving average, same length as input
EMA â‡ {
  a â† 2Ã·1+ğ•¨
  (âŠ‘ğ•©) {(aÃ—ğ•©)+(1-a)Ã—ğ•¨}` ğ•©
}

# n WMA prices â€” weighted moving average
WMA â‡ {
  w â† 1+â†•ğ•¨
  {(+Â´wÃ—ğ•©)Ã·+Â´w}Ë˜ ğ•¨â†•ğ•©
}

# n Std prices â€” rolling population standard deviation
Std â‡ {
  {mâ†(+Â´Ã·â‰ )ğ•© â‹„ âˆš(+Â´(ğ•©-m)â‹†2)Ã·â‰ ğ•©}Ë˜ ğ•¨â†•ğ•©
}

# n Mom prices â€” momentum (price difference)
Mom â‡ {(ğ•¨â†“ğ•©) - ((-ğ•¨)â†“ğ•©)}

# n ROC prices â€” rate of change as percentage
ROC â‡ {100 Ã— ((ğ•¨â†“ğ•©) - ((-ğ•¨)â†“ğ•©)) Ã· (-ğ•¨)â†“ğ•©}

# n RSI prices â€” relative strength index (0-100)
RSI â‡ {
  deltas â† 1â†“ ğ•© - Â»ğ•©
  gains â† 0âŒˆdeltas
  losses â† 0âŒˆ-deltas
  ag â† ğ•¨ Wilder gains
  al â† ğ•¨ Wilder losses
  100 - 100Ã·1+agÃ·alâŒˆ1eÂ¯10
}

# fastâ€¿slowâ€¿sig MACD prices â†’ macdâ€¿signalâ€¿hist
MACD â‡ {
  fastâ€¿slowâ€¿sig â† ğ•¨
  ml â† (fast EMA ğ•©) - slow EMA ğ•©
  sl â† sig EMA ml
  n â† â‰ sl
  mlâ€¿slâ€¿(ml-sl)
}

# n ATR data â€” average true range, takes namespace {high,low,close}
ATR â‡ {
  h â† ğ•©.high â‹„ l â† ğ•©.low â‹„ c â† ğ•©.close
  hl â† h-l
  hc â† |h - Â»c
  lc â† |l - Â»c
  tr â† hlâŒˆhcâŒˆlc
  1â†“ ğ•¨ Wilder tr
}

# n Stoch data â†’ kâ€¿d â€” stochastic oscillator
Stoch â‡ {
  c â† ğ•©.close â‹„ h â† ğ•©.high â‹„ l â† ğ•©.low
  lo â† ğ•¨ RMin l
  hi â† ğ•¨ RMax h
  rng â† hi - lo
  # NOTE: align close to window output (drop n-1 warmup bars)
  k â† 100 Ã— (((ğ•¨-1)â†“c)-lo) Ã· rngâŒˆ1eÂ¯10
  d â† 3 MA k
  kâ€¿d
}

# nâ€¿k BB prices â†’ upperâ€¿midâ€¿lower â€” Bollinger Bands
BB â‡ {
  nâ€¿k â† ğ•¨
  mid â† n MA ğ•©
  sd â† n Std ğ•©
  (mid+kÃ—sd)â€¿midâ€¿(mid-kÃ—sd)
}

# OBV closeâ€¿vol â€” on-balance volume (monadic)
OBV â‡ {
  câ€¿v â† ğ•©
  signs â† Ã— -âŸœÂ» c
  +` signs Ã— v
}

# VWAP data â€” volume-weighted average price (monadic, takes namespace)
VWAP â‡ {
  tp â† (ğ•©.high + ğ•©.low + ğ•©.close) Ã· 3
  (+`tpÃ—ğ•©.vol) Ã· +`ğ•©.vol
}

# AD data â€” accumulation/distribution line (monadic, takes namespace)
AD â‡ {
  hâ†ğ•©.high â‹„ lâ†ğ•©.low â‹„ câ†ğ•©.close â‹„ vâ†ğ•©.vol
  rng â† h-l
  mfm â† ((c-l)-(h-c)) Ã· rngâŒˆ1eÂ¯10
  +` mfm Ã— v
}

# â”€â”€ Signal Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# fast Cross slow â€” 1 where fast crosses above slow
Cross â‡ {(ğ•¨â‰¥ğ•©) âˆ§ (Â»ğ•¨)<Â»ğ•©}

# fast CrossDown slow â€” 1 where fast crosses below slow
CrossDown â‡ {(ğ•¨â‰¤ğ•©) âˆ§ (Â»ğ•¨)>Â»ğ•©}

# n Mask arr â€” zero first n elements, same length
Mask â‡ {(ğ•¨â¥Š0)âˆ¾ğ•¨â†“ğ•©}

# Fill signals â€” forward-fill: hold last non-zero
Fill â‡ {(âŠ‘ğ•©){ğ•©+(ğ•©=0)Ã—ğ•¨}`ğ•©}

# level Thresh values â€” 1 where value crosses above level
Thresh â‡ {(ğ•©>ğ•¨) âˆ§ (Â»ğ•©)â‰¤ğ•¨}

# level ThreshDown values â€” 1 where value crosses below level
ThreshDown â‡ {(ğ•©<ğ•¨) âˆ§ (Â»ğ•©)â‰¥ğ•¨}

# n Hold positions â€” min n-bar holding period
Hold â‡ {
  n â† ğ•¨ â‹„ pos â† 0 â‹„ count â† 0
  {
    count>0 ? count-â†©1 â‹„ pos;
    ğ•©â‰ pos  ? countâ†©(ğ•©â‰ 0)Ã—n-1 â‹„ posâ†©ğ•©;
    pos
  }Â¨ ğ•©
}

# â”€â”€ Simulation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Step _Sim initâ€¿obs â†’ positions
# Step: state ğ”½ observation â†’ new_state (first element = position)
_Sim â‡ {
  initâ€¿obs â† ğ•©
  state â† init
  Fn â† ğ”½
  {
    state â†© state Fn ğ•©
    âŠ‘state
  }Â¨ obs
}

# â”€â”€ Backtest Core â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Ret prices â†’ simple returns (1 shorter than input)
Ret â‡ {(1â†“ğ•©-Â»ğ•©) Ã· 1â†“Â»ğ•©}

# LogRet prices â†’ log returns (1 shorter than input)
LogRet â‡ {1â†“ â‹†â¼ ğ•©Ã·Â»ğ•©}

# pos Run ret â†’ strategy returns
Run â‡ Ã—

# rate Cost pos â†’ transaction cost array
Cost â‡ {ğ•¨ Ã— |-âŸœÂ»ğ•©}

# Equity ret â†’ equity curve starting at 1
Equity â‡ {Ã—`1+ğ•©}

# â”€â”€ Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Internal: drawdown series from returns
DdSeries â† {
  eq â† Ã—`1+ğ•©
  mx â† âŒˆ`eq
  (eq-mx)Ã·mx
}

# Internal: population std
Pstd â† {mâ†(+Â´Ã·â‰ )ğ•© â‹„ âˆš(+Â´(ğ•©-m)â‹†2)Ã·â‰ ğ•©}

# Annualized Sharpe ratio (Rf=0)
Sharpe â‡ {(âˆš252) Ã— ((+Â´Ã·â‰ )ğ•©) Ã· (Pstd ğ•©)âŒˆ1eÂ¯10}

# Sortino ratio (downside deviation only)
Sortino â‡ {
  m â† (+Â´Ã·â‰ )ğ•©
  dd â† 0âŒŠğ•©
  ds â† âˆš(+Â´ddâ‹†2)Ã·â‰ ğ•©
  (âˆš252) Ã— m Ã· dsâŒˆ1eÂ¯10
}

# Maximum drawdown (negative number)
MaxDD â‡ {âŒŠÂ´ DdSeries ğ•©}

# Longest drawdown duration (bars)
MaxDDDur â‡ {
  dd â† DdSeries ğ•©
  # Count consecutive bars where dd < 0
  run â† 0 â‹„ best â† 0
  {
    dd â† ğ•©
    dd<0 ? run+â†©1 â‹„ bestâ†©bestâŒˆrun;
    runâ†©0
  }Â¨ dd
  bestâŒˆrun
}

# Total cumulative return
TotalRet â‡ {Â¯1+(Â¯1âŠ‘Ã—`1+ğ•©)}

# Compound annual growth rate (252 days/yr)
CAGR â‡ {((Â¯1âŠ‘Ã—`1+ğ•©)â‹†252Ã·â‰ ğ•©)-1}

# Annualized volatility
AnnVol â‡ {(Pstd ğ•©)Ã—âˆš252}

# Calmar ratio (CAGR / |MaxDD|)
Calmar â‡ {(CAGR ğ•©) Ã· (|MaxDD ğ•©)âŒˆ1eÂ¯10}

# Win rate (positive days / active days)
WinRate â‡ {
  active â† ğ•©â‰ 0
  (+Â´ğ•©>0) Ã· (+Â´active)âŒˆ1
}

# Profit factor (gross profit / gross loss)
ProfitFactor â‡ {
  (+Â´(ğ•©>0)Ã—ğ•©) Ã· (|+Â´(ğ•©<0)Ã—ğ•©)âŒˆ1eÂ¯10
}

# Average winning return
AvgWin â‡ {wâ†(ğ•©>0)/ğ•© â‹„ 0=â‰ w ? 0; wâ†(ğ•©>0)/ğ•© â‹„ (+Â´Ã·â‰ )w}

# Average losing return (negative number)
AvgLoss â‡ {lâ†(ğ•©<0)/ğ•© â‹„ 0=â‰ l ? 0; lâ†(ğ•©<0)/ğ•© â‹„ (+Â´Ã·â‰ )l}

# Expectancy (expected value per trade)
Expectancy â‡ {
  wr â† WinRate ğ•©
  (wr Ã— AvgWin ğ•©) + (1-wr) Ã— AvgLoss ğ•©
}

# Trades â€” count position changes (takes positions)
Trades â‡ {+Â´(Â»ğ•©)â‰ ğ•©}

# Time in market (takes positions)
TimeIn â‡ {(+Â´ğ•©â‰ 0)Ã·â‰ ğ•©}

# Exposure â€” alias for TimeIn
Exposure â‡ TimeIn

# Skewness (third standardized moment)
Skew â‡ {
  m â† (+Â´Ã·â‰ )ğ•©
  s â† Pstd ğ•©
  (+Â´((ğ•©-m)Ã·sâŒˆ1eÂ¯10)â‹†3) Ã· â‰ ğ•©
}

# Excess kurtosis (fourth standardized moment minus 3)
Kurt â‡ {
  m â† (+Â´Ã·â‰ )ğ•©
  s â† Pstd ğ•©
  Â¯3 + (+Â´((ğ•©-m)Ã·sâŒˆ1eÂ¯10)â‹†4) Ã· â‰ ğ•©
}
