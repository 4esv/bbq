# bbq â€” BQN Backtesting for Quant
# engine/bt.bqn â€” all public API

# â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# NOTE: yfinance CSV format: 3 header lines, then Date,Close,High,Low,Open,Volume
Split â† (âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŸœ','âŠ¸âŠ”

Load â‡ {
  lines â† â€¢FLines ğ•©
  rows â† SplitÂ¨ 3â†“lines
  dates â‡ 0âŠ¸âŠ‘Â¨ rows
  close â‡ â€¢ParseFloatÂ¨ 1âŠ¸âŠ‘Â¨ rows
  high  â‡ â€¢ParseFloatÂ¨ 2âŠ¸âŠ‘Â¨ rows
  low   â‡ â€¢ParseFloatÂ¨ 3âŠ¸âŠ‘Â¨ rows
  open  â‡ â€¢ParseFloatÂ¨ 4âŠ¸âŠ‘Â¨ rows
  vol   â‡ â€¢ParseFloatÂ¨ 5âŠ¸âŠ‘Â¨ rows
}

# â”€â”€ Indicators â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Wilder smoothing (EMA with Î±=1/n). Used by RSI and ATR.
Wilder â† {aâ†Ã·ğ•¨ â‹„ (âŠ‘ğ•©){(aÃ—ğ•©)+(1-a)Ã—ğ•¨}`ğ•©}

# n RMax prices â€” rolling maximum
RMax â‡ {âŒˆÂ´Ë˜ ğ•¨â†•ğ•©}

# n RMin prices â€” rolling minimum
RMin â‡ {âŒŠÂ´Ë˜ ğ•¨â†•ğ•©}

# n MA prices â€” simple moving average, O(n) via prefix-sum
MA â‡ {
  cs â† 0âˆ¾+`ğ•©
  ((ğ•¨â†“cs) - ((-ğ•¨)â†“cs)) Ã· ğ•¨
}

# n EMA prices â€” exponential moving average, same length as input
EMA â‡ {
  a â† 2Ã·1+ğ•¨
  (âŠ‘ğ•©) {(aÃ—ğ•©)+(1-a)Ã—ğ•¨}` ğ•©
}

# n WMA prices â€” weighted moving average
WMA â‡ {
  w â† 1+â†•ğ•¨
  {(+Â´wÃ—ğ•©)Ã·+Â´w}Ë˜ ğ•¨â†•ğ•©
}

# n Std prices â€” rolling population standard deviation
Std â‡ {
  {mâ†(+Â´Ã·â‰ )ğ•© â‹„ âˆš(+Â´(ğ•©-m)â‹†2)Ã·â‰ ğ•©}Ë˜ ğ•¨â†•ğ•©
}

# n Mom prices â€” momentum (price difference)
Mom â‡ {(ğ•¨â†“ğ•©) - ((-ğ•¨)â†“ğ•©)}

# n ROC prices â€” rate of change as percentage
ROC â‡ {100 Ã— ((ğ•¨â†“ğ•©) - ((-ğ•¨)â†“ğ•©)) Ã· (-ğ•¨)â†“ğ•©}

# n RSI prices â€” relative strength index (0-100)
RSI â‡ {
  deltas â† 1â†“ ğ•© - Â»ğ•©
  gains â† 0âŒˆdeltas
  losses â† 0âŒˆ-deltas
  ag â† ğ•¨ Wilder gains
  al â† ğ•¨ Wilder losses
  100 - 100Ã·1+agÃ·alâŒˆ1eÂ¯10
}

# fastâ€¿slowâ€¿sig MACD prices â†’ macdâ€¿signalâ€¿hist
MACD â‡ {
  fastâ€¿slowâ€¿sig â† ğ•¨
  ml â† (fast EMA ğ•©) - slow EMA ğ•©
  sl â† sig EMA ml
  n â† â‰ sl
  mlâ€¿slâ€¿(ml-sl)
}

# n ATR data â€” average true range, takes namespace {high,low,close}
ATR â‡ {
  h â† ğ•©.high â‹„ l â† ğ•©.low â‹„ c â† ğ•©.close
  hl â† h-l
  hc â† |h - Â»c
  lc â† |l - Â»c
  tr â† hlâŒˆhcâŒˆlc
  1â†“ ğ•¨ Wilder tr
}

# n Stoch data â†’ kâ€¿d â€” stochastic oscillator
Stoch â‡ {
  c â† ğ•©.close â‹„ h â† ğ•©.high â‹„ l â† ğ•©.low
  lo â† ğ•¨ RMin l
  hi â† ğ•¨ RMax h
  rng â† hi - lo
  # NOTE: align close to window output (drop n-1 warmup bars)
  k â† 100 Ã— (((ğ•¨-1)â†“c)-lo) Ã· rngâŒˆ1eÂ¯10
  d â† 3 MA k
  kâ€¿d
}

# nâ€¿k BB prices â†’ upperâ€¿midâ€¿lower â€” Bollinger Bands
BB â‡ {
  nâ€¿k â† ğ•¨
  mid â† n MA ğ•©
  sd â† n Std ğ•©
  (mid+kÃ—sd)â€¿midâ€¿(mid-kÃ—sd)
}

# OBV closeâ€¿vol â€” on-balance volume (monadic)
OBV â‡ {
  câ€¿v â† ğ•©
  signs â† Ã— -âŸœÂ» c
  +` signs Ã— v
}

# VWAP data â€” volume-weighted average price (monadic, takes namespace)
VWAP â‡ {
  tp â† (ğ•©.high + ğ•©.low + ğ•©.close) Ã· 3
  (+`tpÃ—ğ•©.vol) Ã· +`ğ•©.vol
}

# AD data â€” accumulation/distribution line (monadic, takes namespace)
AD â‡ {
  hâ†ğ•©.high â‹„ lâ†ğ•©.low â‹„ câ†ğ•©.close â‹„ vâ†ğ•©.vol
  rng â† h-l
  mfm â† ((c-l)-(h-c)) Ã· rngâŒˆ1eÂ¯10
  +` mfm Ã— v
}
