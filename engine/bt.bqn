# bbq â€” BQN Backtesting for Quant
# engine/bt.bqn

# â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

eps â† 1eÂ¯10  # division guard
tdy â† 252    # trading days/year

# â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# NOTE: yfinance CSV format: 3 header lines, then Date,Close,High,Low,Open,Volume
Split â† (âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŸœ','âŠ¸âŠ”

Load â‡ {
  lines â† â€¢FLines ğ•©
  rows â† SplitÂ¨ 3â†“lines
  ! âˆ§Â´6â‰¤â‰ Â¨rows
  dates â‡ 0âŠ¸âŠ‘Â¨ rows
  close â‡ â€¢ParseFloatÂ¨ 1âŠ¸âŠ‘Â¨ rows
  high  â‡ â€¢ParseFloatÂ¨ 2âŠ¸âŠ‘Â¨ rows
  low   â‡ â€¢ParseFloatÂ¨ 3âŠ¸âŠ‘Â¨ rows
  open  â‡ â€¢ParseFloatÂ¨ 4âŠ¸âŠ‘Â¨ rows
  vol   â‡ â€¢ParseFloatÂ¨ 5âŠ¸âŠ‘Â¨ rows
}

Validate â‡ {
  ! 0<â‰ ğ•©.close
  n â† â‰ ğ•©.close
  ! n=â‰ ğ•©.high
  ! n=â‰ ğ•©.low
  ! n=â‰ ğ•©.open
  ! n=â‰ ğ•©.vol
  ! âˆ§Â´ğ•©.close>0
  ! âˆ§Â´ğ•©.high>0
  ! âˆ§Â´ğ•©.low>0
  ! âˆ§Â´ğ•©.open>0
  ! âˆ§Â´ğ•©.highâ‰¥ğ•©.low
  ! âˆ§Â´ğ•©.highâ‰¥ğ•©.close
  ! âˆ§Â´ğ•©.highâ‰¥ğ•©.open
  ! âˆ§Â´ğ•©.lowâ‰¤ğ•©.close
  ! âˆ§Â´ğ•©.lowâ‰¤ğ•©.open
  ğ•©
}

Align â‡ {mâ†âŒŠÂ´â‰ Â¨ğ•© â‹„ (-m)â†‘Â¨ğ•©}

# â”€â”€ Indicators â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Wilder smoothing (EMA with Î±=1/n). Used by RSI and ATR.
Wilder â† {aâ†Ã·ğ•¨ â‹„ (âŠ‘ğ•©){(aÃ—ğ•©)+(1-a)Ã—ğ•¨}`ğ•©}

# n RMax prices â€” rolling maximum
RMax â‡ {âŒˆÂ´Ë˜ ğ•¨â†•ğ•©}

# n RMin prices â€” rolling minimum
RMin â‡ {âŒŠÂ´Ë˜ ğ•¨â†•ğ•©}

# n MA prices â€” simple moving average, O(n) via prefix-sum
MA â‡ {
  cs â† 0âˆ¾+`ğ•©
  ((ğ•¨â†“cs) - ((-ğ•¨)â†“cs)) Ã· ğ•¨
}

# n EMA prices â€” exponential moving average, same length as input
EMA â‡ {
  a â† 2Ã·1+ğ•¨
  (âŠ‘ğ•©) {(aÃ—ğ•©)+(1-a)Ã—ğ•¨}` ğ•©
}

# n WMA prices â€” weighted moving average
WMA â‡ {
  w â† 1+â†•ğ•¨
  {(+Â´wÃ—ğ•©)Ã·+Â´w}Ë˜ ğ•¨â†•ğ•©
}

# n Std prices â€” rolling population standard deviation
Std â‡ {
  {mâ†(+Â´Ã·â‰ )ğ•© â‹„ âˆš(+Â´(ğ•©-m)â‹†2)Ã·â‰ ğ•©}Ë˜ ğ•¨â†•ğ•©
}

# n Mom prices â€” momentum (price difference)
Mom â‡ {(ğ•¨â†“ğ•©) - ((-ğ•¨)â†“ğ•©)}

# n ROC prices â€” rate of change as percentage
ROC â‡ {100 Ã— ((ğ•¨â†“ğ•©) - ((-ğ•¨)â†“ğ•©)) Ã· (-ğ•¨)â†“ğ•©}

# n RSI prices â€” relative strength index (0-100)
RSI â‡ {
  deltas â† 1â†“ ğ•© - Â»ğ•©
  gains â† 0âŒˆdeltas
  losses â† 0âŒˆ-deltas
  ag â† ğ•¨ Wilder gains
  al â† ğ•¨ Wilder losses
  100 - 100Ã·1+agÃ·alâŒˆeps
}

# fastâ€¿slowâ€¿sig MACD prices â†’ macdâ€¿signalâ€¿hist
MACD â‡ {
  fastâ€¿slowâ€¿sig â† ğ•¨
  ml â† (fast EMA ğ•©) - slow EMA ğ•©
  sl â† sig EMA ml
  mlâ€¿slâ€¿(ml-sl)
}

# n ATR data â€” average true range, takes namespace {high,low,close}
ATR â‡ {
  h â† ğ•©.high â‹„ l â† ğ•©.low â‹„ c â† ğ•©.close
  hl â† h-l
  hc â† |h - Â»c
  lc â† |l - Â»c
  tr â† hlâŒˆhcâŒˆlc
  1â†“ ğ•¨ Wilder tr
}

# n Stoch data â†’ kâ€¿d â€” stochastic oscillator
Stoch â‡ {
  c â† ğ•©.close â‹„ h â† ğ•©.high â‹„ l â† ğ•©.low
  lo â† ğ•¨ RMin l
  hi â† ğ•¨ RMax h
  rng â† hi - lo
  # NOTE: align close to window output (drop n-1 warmup bars)
  k â† 100 Ã— (((ğ•¨-1)â†“c)-lo) Ã· rngâŒˆeps
  d â† 3 MA k
  kâ€¿d
}

# nâ€¿k BB prices â†’ upperâ€¿midâ€¿lower â€” Bollinger Bands
BB â‡ {
  nâ€¿k â† ğ•¨
  mid â† n MA ğ•©
  sd â† n Std ğ•©
  (mid+kÃ—sd)â€¿midâ€¿(mid-kÃ—sd)
}

# OBV closeâ€¿vol â€” on-balance volume (monadic)
OBV â‡ {
  câ€¿v â† ğ•©
  signs â† Ã— -âŸœÂ» c
  +` signs Ã— v
}

# VWAP data â€” volume-weighted average price (monadic, takes namespace)
VWAP â‡ {
  tp â† (ğ•©.high + ğ•©.low + ğ•©.close) Ã· 3
  (+`tpÃ—ğ•©.vol) Ã· +`ğ•©.vol
}

# AD data â€” accumulation/distribution line (monadic, takes namespace)
AD â‡ {
  hâ†ğ•©.high â‹„ lâ†ğ•©.low â‹„ câ†ğ•©.close â‹„ vâ†ğ•©.vol
  rng â† h-l
  mfm â† ((c-l)-(h-c)) Ã· rngâŒˆeps
  +` mfm Ã— v
}

# â”€â”€ Signal Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# fast Cross slow â€” 1 where fast crosses above slow
Cross â‡ {(ğ•¨â‰¥ğ•©) âˆ§ (Â»ğ•¨)<Â»ğ•©}

# fast CrossDown slow â€” 1 where fast crosses below slow
CrossDown â‡ {(ğ•¨â‰¤ğ•©) âˆ§ (Â»ğ•¨)>Â»ğ•©}

# n Mask arr â€” zero first n elements, same length
Mask â‡ {(ğ•¨â¥Š0)âˆ¾ğ•¨â†“ğ•©}

# Fill signals â€” forward-fill: hold last non-zero
Fill â‡ {(âŠ‘ğ•©){ğ•©+(ğ•©=0)Ã—ğ•¨}`ğ•©}

# level Thresh values â€” 1 where value crosses above level
Thresh â‡ {(ğ•©>ğ•¨) âˆ§ (Â»ğ•©)â‰¤ğ•¨}

# level ThreshDown values â€” 1 where value crosses below level
ThreshDown â‡ {(ğ•©<ğ•¨) âˆ§ (Â»ğ•©)â‰¥ğ•¨}

# n Hold positions â€” min n-bar holding period
Hold â‡ {
  n â† ğ•¨ â‹„ pos â† 0 â‹„ count â† 0
  {
    count>0 ? count-â†©1 â‹„ pos;
    ğ•©â‰ pos  ? countâ†©(ğ•©â‰ 0)Ã—n-1 â‹„ posâ†©ğ•©;
    pos
  }Â¨ ğ•©
}

# â”€â”€ Simulation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Step _Sim initâ€¿obs â†’ positions
# Step: state ğ”½ observation â†’ new_state (first element = position)
_Sim â‡ {
  Fn â† ğ”½
  initâ€¿obs â† ğ•©
  state â† init
  {
    state â†© state Fn ğ•©
    âŠ‘state
  }Â¨ obs
}

# â”€â”€ Backtest Core â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Ret prices â†’ simple returns (1 shorter than input)
Ret â‡ {(1â†“ğ•©-Â»ğ•©) Ã· 1â†“Â»ğ•©}

# LogRet prices â†’ log returns (1 shorter than input)
LogRet â‡ {1â†“ â‹†â¼ ğ•©Ã·Â»ğ•©}

# pos Run ret â†’ strategy returns
Run â‡ Ã—

# rate Cost pos â†’ transaction cost array
Cost â‡ {ğ•¨ Ã— |-âŸœÂ»ğ•©}

# Equity ret â†’ equity curve starting at 1
Equity â‡ {Ã—`1+ğ•©}

# â”€â”€ Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Internal: drawdown series from returns
DdSeries â† {
  eq â† Ã—`1+ğ•©
  mx â† âŒˆ`eq
  (eq-mx)Ã·mx
}

# Internal: population std
Pstd â† {mâ†(+Â´Ã·â‰ )ğ•© â‹„ âˆš(+Â´(ğ•©-m)â‹†2)Ã·â‰ ğ•©}

# Annualized Sharpe ratio (Rf=0)
Sharpe â‡ {(âˆštdy) Ã— ((+Â´Ã·â‰ )ğ•©) Ã· (Pstd ğ•©)âŒˆeps}

# Sortino ratio (downside deviation only)
Sortino â‡ {
  m â† (+Â´Ã·â‰ )ğ•©
  dd â† 0âŒŠğ•©
  ds â† âˆš(+Â´ddâ‹†2)Ã·â‰ ğ•©
  (âˆštdy) Ã— m Ã· dsâŒˆeps
}

# Maximum drawdown (negative number)
MaxDD â‡ {âŒŠÂ´ DdSeries ğ•©}

# Longest drawdown duration (bars)
MaxDDDur â‡ {âŒˆÂ´0{ğ•©Ã—1+ğ•¨}`(DdSeries ğ•©)<0}

# Total cumulative return
TotalRet â‡ {Â¯1+(Â¯1âŠ‘Ã—`1+ğ•©)}

# Compound annual growth rate (252 days/yr)
CAGR â‡ {((Â¯1âŠ‘Ã—`1+ğ•©)â‹†tdyÃ·â‰ ğ•©)-1}

# Annualized volatility
AnnVol â‡ {(Pstd ğ•©)Ã—âˆštdy}

# Calmar ratio (CAGR / |MaxDD|)
Calmar â‡ {(CAGR ğ•©) Ã· (|MaxDD ğ•©)âŒˆeps}

# Win rate (positive days / active days)
WinRate â‡ {
  active â† ğ•©â‰ 0
  (+Â´ğ•©>0) Ã· (+Â´active)âŒˆ1
}

# Profit factor (gross profit / gross loss)
ProfitFactor â‡ {
  (+Â´(ğ•©>0)Ã—ğ•©) Ã· (|+Â´(ğ•©<0)Ã—ğ•©)âŒˆeps
}

# Average winning return
AvgWin â‡ {wâ†(ğ•©>0)/ğ•© â‹„ (+Â´w)Ã·(â‰ w)âŒˆ1}

# Average losing return (negative number)
AvgLoss â‡ {lâ†(ğ•©<0)/ğ•© â‹„ (+Â´l)Ã·(â‰ l)âŒˆ1}

# Expectancy (expected value per trade)
Expectancy â‡ {
  wr â† WinRate ğ•©
  (wr Ã— AvgWin ğ•©) + (1-wr) Ã— AvgLoss ğ•©
}

# Trades â€” count position changes (takes positions)
Trades â‡ {+Â´(Â»ğ•©)â‰ ğ•©}

# Time in market (takes positions)
TimeIn â‡ {(+Â´ğ•©â‰ 0)Ã·â‰ ğ•©}

# Exposure â€” alias for TimeIn
Exposure â‡ TimeIn

# Skewness (third standardized moment)
Skew â‡ {
  m â† (+Â´Ã·â‰ )ğ•©
  s â† Pstd ğ•©
  (+Â´((ğ•©-m)Ã·sâŒˆeps)â‹†3) Ã· â‰ ğ•©
}

# Excess kurtosis (fourth standardized moment minus 3)
Kurt â‡ {
  m â† (+Â´Ã·â‰ )ğ•©
  s â† Pstd ğ•©
  Â¯3 + (+Â´((ğ•©-m)Ã·sâŒˆeps)â‹†4) Ã· â‰ ğ•©
}

# â”€â”€ Reporting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# nameâ€¿pos Report strat_retâ€¿bh_ret â€” print formatted summary
Report â‡ {
  nameâ€¿pos â† ğ•¨
  stratâ€¿bh â† ğ•©

  # Format percentage with sign
  Pct â† {
    v â† âŒŠ0.5+1000Ã—|ğ•©
    d â† â€¢Fmt 10|v
    w â† â€¢Fmt âŒŠvÃ·10
    ((ğ•©â‰¥0)âŠ‘"-+"âˆ¾Â¨<"") âˆ¾ w âˆ¾ "." âˆ¾ d âˆ¾ "%"
  }

  # Round to 2 decimal places with sign
  Rd â† {
    v â† âŒŠ0.5+100Ã—|ğ•©
    d â† â€¢Fmt 100|v
    d â†© ((2>â‰ d)/"0") âˆ¾ d
    w â† â€¢Fmt âŒŠvÃ·100
    ((ğ•©<0)/"-") âˆ¾ w âˆ¾ "." âˆ¾ d
  }

  # Right-pad string to width
  Pad â† {(ğ•¨âŒˆâ‰ ğ•©)â†‘ğ•©}

  # Format a metric line: label, strategy value, benchmark value
  Line â† {lâ€¿svâ€¿bv:
    (16 Pad l) âˆ¾ (10 Pad sv) âˆ¾ "  (B&H: " âˆ¾ bv âˆ¾ ")"
  }

  # Format a solo metric line (no benchmark)
  Solo â† {lâ€¿sv:
    (16 Pad l) âˆ¾ sv
  }

  paired â† âŸ¨
    "Total:"â€¿(Pct TotalRet strat)â€¿(Pct TotalRet bh)
    "CAGR:"â€¿(Pct CAGR strat)â€¿(Pct CAGR bh)
    "Sharpe:"â€¿(Rd Sharpe strat)â€¿(Rd Sharpe bh)
    "Sortino:"â€¿(Rd Sortino strat)â€¿(Rd Sortino bh)
    "MaxDD:"â€¿(Pct MaxDD strat)â€¿(Pct MaxDD bh)
    "MaxDD Dur:"â€¿(â€¢Fmt MaxDDDur strat)â€¿(â€¢Fmt MaxDDDur bh)
    "Calmar:"â€¿(Rd Calmar strat)â€¿(Rd Calmar bh)
    "Volatility:"â€¿(Pct AnnVol strat)â€¿(Pct AnnVol bh)
  âŸ©

  singles â† âŸ¨
    "Win Rate:"â€¿(Pct WinRate strat)
    "Profit Factor:"â€¿(Rd ProfitFactor strat)
    "Expectancy:"â€¿(Pct Expectancy strat)
    "Trades:"â€¿(â€¢Fmt Trades pos)
    "Time In:"â€¿(Pct TimeIn pos)
    "Skew:"â€¿(Rd Skew strat)
    "Kurtosis:"â€¿(Rd Kurt strat)
  âŸ©

  â€¢Out "â•â•â• " âˆ¾ name âˆ¾ " â•â•â•"
  â€¢OutÂ¨ LineÂ¨ paired
  â€¢OutÂ¨ SoloÂ¨ singles

  # Verdict
  sharpe â† Sharpe strat
  maxdd â† MaxDD strat
  verdict â† {
    maxdd<Â¯0.40 ? "Max drawdown > 40%, reconsider";
    sharpeâ‰¥1.0  ? "Worth paper trading";
    sharpeâ‰¥0.5  ? "Has potential, needs work";
    "Not worth pursuing"
  }
  â€¢Out "â”€â”€â”€"
  â€¢Out "Verdict: " âˆ¾ verdict
}
