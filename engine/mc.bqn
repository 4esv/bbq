# bbq â€” BQN Based Quant
# engine/mc.bqn â€” Monte Carlo simulation

core â† â€¢Import "core.bqn"
opt â† â€¢Import "opt.bqn"
eps â† core.eps

# â”€â”€ RNG (internal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Unif n â†’ n uniform floats in (0,1)
Unif â† {(ğ•© â€¢rand.Range 1000000000) Ã· 1000000000}

# Randn n â†’ n standard normal samples (Box-Muller)
Randn â† {
  half â† âŒˆğ•©Ã·2
  u1 â† epsâŒˆUnif half
  u2 â† Unif half
  r â† âˆš-2Ã—â‹†â¼u1
  a â† 2Ã—Ï€Ã—u2
  ğ•©â†‘(rÃ—â€¢math.Cos a)âˆ¾rÃ—â€¢math.Sin a
}

# â”€â”€ Formatting (internal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Rd4 â€” round to 4 decimal places
Rd4 â† {
  v â† âŒŠ0.5+10000Ã—|ğ•©
  d â† Â¯4â†‘"0000"âˆ¾â€¢Fmt 10000|v
  ((ğ•©<0)/"-") âˆ¾ (â€¢Fmt âŒŠvÃ·10000) âˆ¾ "." âˆ¾ d
}

# LPad â€” left-pad string to width (right-align)
LPad â† {((ğ•¨-â‰ ğ•©)â¥Š' ')âˆ¾ğ•©}

# â”€â”€ Path Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# NOTE: Paths takes Î¼ (real-world drift). For risk-neutral pricing, pass r as Î¼.
# _Price discounts at r. These are intentionally separate parameters.

# GbmZ nâ€¿s0â€¿muâ€¿sigâ€¿tâ€¿steps â†’ driftâ€¿diffâ€¿zâ€¿s0 (shared GBM setup)
GbmZ â† {
  nâ€¿s0â€¿muâ€¿sigâ€¿tâ€¿steps â† ğ•©
  dt â† tÃ·steps
  âŸ¨(mu - 0.5Ã—sigâ‹†2) Ã— dt, sig Ã— âˆšdt, nâ€¿steps â¥Š Randn nÃ—steps, s0âŸ©
}

# Paths nâ€¿Sâ‚€â€¿Î¼â€¿Ïƒâ€¿Tâ€¿steps â†’ [n, steps] price paths (GBM)
# Î¼ = drift rate (use risk-free rate r for risk-neutral pricing)
Paths â‡ {
  driftâ€¿diffâ€¿zâ€¿s0 â† GbmZ ğ•©
  s0 Ã— â‹† +`Ë˜ drift + diffÃ—z
}

# â”€â”€ Payoff Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# k EuroCall path â†’ payoff
EuroCall â‡ {0âŒˆ(Â¯1âŠ‘ğ•©)-ğ•¨}

# k EuroPut path â†’ payoff
EuroPut â‡ {0âŒˆğ•¨-Â¯1âŠ‘ğ•©}

# k AsianCall path â†’ payoff (arithmetic average)
AsianCall â‡ {0âŒˆ((+Â´Ã·â‰ )ğ•©)-ğ•¨}

# kâ€¿barrier BarrierUpOut path â†’ payoff (knocked out if any price â‰¥ barrier)
# NOTE: barrier touch (price = barrier) triggers knockout
BarrierUpOut â‡ {kâ€¿bâ†ğ•¨ â‹„ (âˆ§Â´ğ•©<b) Ã— 0âŒˆ(Â¯1âŠ‘ğ•©)-k}

# â”€â”€ Pricing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Payoff _Price pathsâ€¿râ€¿T â†’ discounted expected payoff
_Price â‡ {
  pathsâ€¿râ€¿t â† ğ•©
  (â‹†-rÃ—t) Ã— (+Â´Ã·â‰ ) ğ”½Ë˜ paths
}

# â”€â”€ Variance Reduction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Paths _Antithetic config â†’ [2n, steps] (antithetic variates)
_Antithetic â‡ {ğ”½
  driftâ€¿diffâ€¿zâ€¿s0 â† GbmZ ğ•©
  dz â† diffÃ—z
  (s0 Ã— â‹† +`Ë˜ drift+dz) âˆ¾ s0 Ã— â‹† +`Ë˜ drift-dz
}
