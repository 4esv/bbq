# bbq â€” BQN Based Quant
# engine/wf.bqn â€” walk-forward validation

bt â† â€¢Import "bt.bqn"

# Re-export bt (which includes core)
âŸ¨Load, Validate, Align,
 MA, EMA, WMA, Std, RSI, MACD, ATR, Mom, ROC, Stoch, BB, OBV, VWAP, AD, RMax, RMin,
 Cross, CrossDown, Mask, Fill, Thresh, ThreshDown, Hold,
 _Sim, Ret, LogRet, Run, Cost, Equity,
 Sharpe, Sortino, MaxDD, MaxDDDur, TotalRet, CAGR, AnnVol, Calmar,
 WinRate, ProfitFactor, AvgWin, AvgLoss, Expectancy, Trades, TimeIn, Exposure, Skew, Kurt,
 Report, PortRun, PortCost, PortEquity, PortReportâŸ© â‡ bt

# â”€â”€ Walk-Forward â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# trainâ€¿test Windows prices â€” rolling train/test window splits
Windows â‡ {
  trâ€¿te â† ğ•¨ â‹„ p â† ğ•©
  nf â† 1+âŒŠ((â‰ p)-tr+te)Ã·te
  ! nf>0
  {s â† ğ•©Ã—te â‹„ âŸ¨trâ†‘sâ†“p, teâ†‘(s+tr)â†“pâŸ©}Â¨ â†•nf
}

# Grid ranges â€” cartesian product of parameter ranges
Grid â‡ {
  ! 0<â‰ ğ•©
  1=â‰ ğ•© ? <Â¨âŠ‘ğ•©;
  rest â† ğ•Š 1â†“ğ•©
  âˆ¾ {ğ•©âŠ¸âˆ¾Â¨ rest}Â¨ âŠ‘ğ•©
}

# prices Strategy _WF config â†’ results
# Strategy: params ğ”½ prices â†’ positions
# config: trainâ€¿testâ€¿gridâ€¿cost_rateâ€¿Metric
_WF â‡ {
  Strat â† ğ”½
  trâ€¿teâ€¿gridâ€¿crâ€¿Metric â† ğ•©
  prices â† ğ•¨

  folds â† trâ€¿te Windows prices
  ret_all â† bt.Ret prices
  fold_results â† âŸ¨âŸ©

  {
    train_pâ€¿test_p â† ğ•©
    train_ret â† bt.Ret train_p
    test_ret â† bt.Ret test_p

    # Grid search on train
    scores â† {
      pos â† (-â‰ train_ret)â†‘ ğ•© Strat train_p
      sr â† pos bt.Run train_ret
      cost â† cr bt.Cost pos
      Metric sr-cost
    }Â¨ grid

    best_idx â† âŠ‘â’scores
    best_params â† best_idxâŠ‘grid
    train_metric â† best_idxâŠ‘scores

    # Evaluate best params on test
    test_pos â† (-â‰ test_ret)â†‘ best_params Strat test_p
    test_sr â† test_pos bt.Run test_ret
    test_cost â† cr bt.Cost test_pos
    test_oos â† test_sr - test_cost
    test_metric â† Metric test_oos

    fold_results âˆ¾â†© <{paramsâ‡best_params, train_scoreâ‡train_metric, test_scoreâ‡test_metric, oos_retâ‡test_oos}
  }Â¨ folds

  oos_ret â† âˆ¾ {ğ•©.oos_ret}Â¨ fold_results
  oos_eq â† bt.Equity oos_ret
  summary â† {sharpeâ‡bt.Sharpe oos_ret, maxddâ‡bt.MaxDD oos_ret, total_retâ‡bt.TotalRet oos_ret, calmarâ‡bt.Calmar oos_ret}

  {foldsâ‡fold_results, oos_retâ‡oos_ret, oos_eqâ‡oos_eq, summaryâ‡summary}
}
