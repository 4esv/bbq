# bbq â€” BQN Based Quant
# engine/wf.bqn â€” walk-forward validation

bt â† â€¢Import "bt.bqn"

# Re-export bt (which includes core)
âŸ¨eps, tdy, Split, Pstd, Wilder,
 Load, Validate, Align,
 MA, EMA, WMA, Std, RSI, MACD, ATR, Mom, ROC, Stoch, BB, OBV, VWAP, AD, RMax, RMin,
 Cross, CrossDown, Mask, Fill, Thresh, ThreshDown, Hold,
 _Sim, Ret, LogRet, Run, Cost, Equity,
 Sharpe, Sortino, MaxDD, MaxDDDur, TotalRet, CAGR, AnnVol, Calmar,
 WinRate, ProfitFactor, AvgWin, AvgLoss, Expectancy, Trades, TimeIn, Exposure, Skew, Kurt,
 Report, PortRun, PortCost, PortEquity, PortReport,
 Pct, Rd, PadâŸ© â‡ bt

# â”€â”€ Walk-Forward â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# trainâ€¿test Windows prices â€” rolling train/test window splits
Windows â‡ {
  trâ€¿te â† ğ•¨ â‹„ p â† ğ•©
  nf â† 1+âŒŠ((â‰ p)-tr+te)Ã·te
  ! nf>0
  {s â† ğ•©Ã—te â‹„ âŸ¨trâ†‘sâ†“p, teâ†‘(s+tr)â†“pâŸ©}Â¨ â†•nf
}

# Grid ranges â€” cartesian product of parameter ranges
Grid â‡ {
  ! 0<â‰ ğ•©
  1=â‰ ğ•© ? <Â¨âŠ‘ğ•©;
  rest â† ğ•Š 1â†“ğ•©
  âˆ¾ {ğ•©âŠ¸âˆ¾Â¨ rest}Â¨ âŠ‘ğ•©
}

# prices Strategy _WF config â†’ results
# Strategy: params ğ”½ prices â†’ positions
# config: trainâ€¿testâ€¿gridâ€¿cost_rateâ€¿Metric
_WF â‡ {
  Strat â† ğ”½
  trâ€¿teâ€¿gridâ€¿crâ€¿Metric â† ğ•©
  prices â† ğ•¨

  folds â† trâ€¿te Windows prices
  fold_results â† âŸ¨âŸ©

  {
    train_pâ€¿test_p â† ğ•©
    train_ret â† bt.Ret train_p
    test_ret â† bt.Ret test_p

    # Grid search on train
    # NOTE: Â» applies 1-bar lag, head-take aligns pos with ret
    scores â† {
      pos â† (â‰ train_ret)â†‘ Â» ğ•© Strat train_p
      sr â† pos bt.Run train_ret
      cost â† cr bt.Cost pos
      Metric sr-cost
    }Â¨ grid

    # NOTE: â’ breaks ties by first index (lowest param combo)
    best_idx â† âŠ‘â’scores
    best_params â† best_idxâŠ‘grid
    train_metric â† best_idxâŠ‘scores

    # Evaluate best params on test
    test_pos â† (â‰ test_ret)â†‘ Â» best_params Strat test_p
    test_sr â† test_pos bt.Run test_ret
    test_cost â† cr bt.Cost test_pos
    test_oos â† test_sr - test_cost
    test_metric â† Metric test_oos

    fold_results âˆ¾â†© <{paramsâ‡best_params, train_scoreâ‡train_metric, test_scoreâ‡test_metric, oos_retâ‡test_oos}
  }Â¨ folds

  oos_ret â† âˆ¾ {ğ•©.oos_ret}Â¨ fold_results
  oos_eq â† bt.Equity oos_ret
  summary â† {sharpeâ‡bt.Sharpe oos_ret, maxddâ‡bt.MaxDD oos_ret, total_retâ‡bt.TotalRet oos_ret, calmarâ‡bt.Calmar oos_ret}

  {foldsâ‡fold_results, oos_retâ‡oos_ret, oos_eqâ‡oos_eq, summaryâ‡summary}
}

# nameâ€¿trainâ€¿testâ€¿grid_size WFReport results â€” print walk-forward summary
WFReport â‡ {
  nameâ€¿trâ€¿teâ€¿gs â† ğ•¨
  r â† ğ•©

  â€¢Out "â•â•â• Walk-Forward: " âˆ¾ name âˆ¾ " â•â•â•"
  â€¢Out "Folds:        " âˆ¾ â€¢Fmt â‰ r.folds
  â€¢Out "Train window: " âˆ¾ (â€¢Fmt tr) âˆ¾ " bars"
  â€¢Out "Test window:  " âˆ¾ (â€¢Fmt te) âˆ¾ " bars"
  â€¢Out "Grid size:    " âˆ¾ (â€¢Fmt gs) âˆ¾ " combinations"
  â€¢Out ""

  â€¢Out "Fold  Best Params       Train     Test"
  â€¢Out "â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”€â”€â”€â”€â”€     â”€â”€â”€â”€"
  {
    f â† ğ•©âŠ‘r.folds
    pstr â† 1â†“ âˆ¾ "â€¿"âŠ¸âˆ¾Â¨ â€¢FmtÂ¨ f.params
    â€¢Out (6 Pad â€¢Fmt ğ•©) âˆ¾ (18 Pad pstr) âˆ¾ (10 Pad Rd f.train_score) âˆ¾ Rd f.test_score
  }Â¨ â†•â‰ r.folds

  â€¢Out ""
  â€¢Out "â”€â”€â”€ Out-of-Sample Aggregate â”€â”€â”€"
  â€¢Out "Sharpe:         " âˆ¾ Rd r.summary.sharpe
  â€¢Out "Total:          " âˆ¾ Pct r.summary.total_ret
  â€¢Out "MaxDD:          " âˆ¾ Pct r.summary.maxdd
  â€¢Out "Calmar:         " âˆ¾ Rd r.summary.calmar

  # Param stability: count most common param tuple
  all_params â† {ğ•©.params}Â¨ r.folds
  counts â† {p â† ğ•© â‹„ +Â´{pâ‰¡ğ•©}Â¨ all_params}Â¨ all_params
  best_count â† âŒˆÂ´counts
  best_param â† (âŠ‘â’counts)âŠ‘all_params
  pstr â† 1â†“ âˆ¾ "â€¿"âŠ¸âˆ¾Â¨ â€¢FmtÂ¨ best_param
  â€¢Out "Param Stability: " âˆ¾ (â€¢Fmt best_count) âˆ¾ "/" âˆ¾ (â€¢Fmt â‰ r.folds) âˆ¾ " folds chose " âˆ¾ pstr

  # Verdict
  sharpe â† r.summary.sharpe
  maxdd â† r.summary.maxdd
  verdict â† {
    maxdd<Â¯0.40 ? "Max drawdown > 40%, reconsider";
    sharpeâ‰¥1.0  ? "Worth paper trading";
    sharpeâ‰¥0.5  ? "Has potential, needs work";
    "Not worth pursuing"
  }
  â€¢Out "â”€â”€â”€"
  â€¢Out "Verdict: " âˆ¾ verdict
}
