# bbq â€” BQN Based Quant
# engine/roll.bqn â€” rolling analytics

bt â† â€¢Import "bt.bqn"

# â”€â”€ Rolling Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# n RSharpe ret â†’ rolling n-bar annualized Sharpe (sample std N-1)
RSharpe â‡ {
  nâ†ğ•¨ â‹„ râ†ğ•©
  samp â† {
    w â† râŠËœ(ğ•©-(n-1))+â†•n
    m â† (+Â´w)Ã·n
    s â† âˆš(+Â´(w-m)â‹†2)Ã·(n-1)âŒˆ1
    (âˆšbt.tdy) Ã— m Ã· sâŒˆbt.eps
  }Â¨ (n-1)+â†•((â‰ r)-(n-1))
  ((n-1)â¥Š0) âˆ¾ samp
}

# n RVol ret â†’ rolling n-bar annualized vol (sample std N-1)
RVol â‡ {
  nâ†ğ•¨ â‹„ râ†ğ•©
  samp â† {
    w â† râŠËœ(ğ•©-(n-1))+â†•n
    m â† (+Â´w)Ã·n
    (âˆš((+Â´(w-m)â‹†2)Ã·(n-1)âŒˆ1)) Ã— âˆšbt.tdy
  }Â¨ (n-1)+â†•((â‰ r)-(n-1))
  ((n-1)â¥Š0) âˆ¾ samp
}

# n RMaxDD ret â†’ rolling max drawdown over n-bar window
RMaxDD â‡ {
  nâ†ğ•¨ â‹„ râ†ğ•©
  dd â† {
    w â† râŠËœ(ğ•©-(n-1))+â†•n
    eq â† Ã—`1+w
    mx â† âŒˆ`eq
    âŒŠÂ´(eq-mx)Ã·mx
  }Â¨ (n-1)+â†•((â‰ r)-(n-1))
  ((n-1)â¥Š0) âˆ¾ dd
}

# nâ€¿bench RBeta strat â†’ rolling n-bar beta vs benchmark
RBeta â‡ {
  nâ€¿bench â† ğ•¨
  bâ€¿s â† bt.Align benchâ€¿ğ•©
  beta â† {
    ws â† sâŠËœ(ğ•©-(n-1))+â†•n
    wb â† bâŠËœ(ğ•©-(n-1))+â†•n
    ms â† (+Â´ws)Ã·n â‹„ mb â† (+Â´wb)Ã·n
    cov â† (+Â´(ws-ms)Ã—(wb-mb))Ã·(n-1)âŒˆ1
    var â† (+Â´(wb-mb)â‹†2)Ã·(n-1)âŒˆ1
    covÃ·varâŒˆbt.eps
  }Â¨ (n-1)+â†•((â‰ s)-(n-1))
  ((n-1)â¥Š0) âˆ¾ beta
}

# â”€â”€ Scalar Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# benchâ€¿rf Alpha strat â†’ Jensen's alpha (scalar)
Alpha â‡ {
  benchâ€¿rf â† ğ•¨ â‹„ strat â† ğ•©
  bâ€¿s â† bt.Align benchâ€¿strat
  ms â† (+Â´s)Ã·â‰ s â‹„ mb â† (+Â´b)Ã·â‰ b
  cov â† (+Â´(s-ms)Ã—(b-mb))Ã·((â‰ s)-1)âŒˆ1
  var â† (+Â´(b-mb)â‹†2)Ã·((â‰ b)-1)âŒˆ1
  beta â† covÃ·varâŒˆbt.eps
  (bt.CAGR s) - rf + betaÃ—(bt.CAGR b)-rf
}

# bench IR strat â†’ information ratio (scalar)
IR â‡ {
  bâ€¿s â† bt.Align ğ•¨â€¿ğ•©
  diff â† s-b
  m â† (+Â´diff)Ã·â‰ diff
  sd â† âˆš(+Â´(diff-m)â‹†2)Ã·((â‰ diff)-1)âŒˆ1
  (âˆšbt.tdy) Ã— m Ã· sdâŒˆbt.eps
}

# bench UpsideCapture strat â†’ upside capture ratio
UpsideCapture â‡ {
  bâ€¿s â† bt.Align ğ•¨â€¿ğ•©
  mask â† b>0
  sb â† +Â´mask/b
  { sb=0 ? 0 ; (+Â´mask/s) Ã· sb }
}

# bench DownsideCapture strat â†’ downside capture ratio
DownsideCapture â‡ {
  bâ€¿s â† bt.Align ğ•¨â€¿ğ•©
  mask â† b<0
  sb â† +Â´mask/b
  { sb=0 ? 0 ; (+Â´mask/s) Ã· sb }
}

# â”€â”€ Drawdown Episodes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Drawdowns ret â†’ {start, end, depth, dur}
Drawdowns â‡ {
  eq â† Ã—`1+ğ•©
  mx â† âŒˆ`eq
  dds â† (eq-mx)Ã·mx

  in_ep â† 0
  ep_start â† 0
  ep_min_dd â† 0
  episodes â† âŸ¨âŸ©

  {
    i â† ğ•©
    d â† iâŠ‘dds
    { in_ep=0 ?
      { d<0 ?
        in_ep â†© 1
        ep_start â†© i
        ep_min_dd â†© d
      ; @ }
    ;
      { d<ep_min_dd ? ep_min_dd â†© d ; @ }
      { dâ‰¥0 ?
        episodes âˆ¾â†© âŸ¨ep_startâ€¿(i-1)â€¿ep_min_ddâ€¿(i-ep_start)âŸ©
        in_ep â†© 0
      ; @ }
    }
    @
  }Â¨ â†•â‰ eq

  # Close open episode at end of series
  { in_epâ‰ 0 ?
    episodes âˆ¾â†© âŸ¨ep_startâ€¿((â‰ eq)-1)â€¿ep_min_ddâ€¿((â‰ eq)-ep_start)âŸ©
  ; @ }

  { 0=â‰ episodes ?
    {startâ‡âŸ¨âŸ©, endâ‡âŸ¨âŸ©, depthâ‡âŸ¨âŸ©, durâ‡âŸ¨âŸ©}
  ;
    start â‡ {âŠ‘ğ•©}Â¨ episodes
    end   â‡ {1âŠ‘ğ•©}Â¨ episodes
    depth â‡ {2âŠ‘ğ•©}Â¨ episodes
    dur   â‡ {3âŠ‘ğ•©}Â¨ episodes
  }
}
