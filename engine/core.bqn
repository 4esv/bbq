# bbq â€” BQN Based Quant
# engine/core.bqn â€” shared primitives

# â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

eps â‡ 1eÂ¯10  # division guard
tdy â‡ 252    # trading days/year

# â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# NOTE: yfinance CSV format: 3 header lines, then Date,Close,High,Low,Open,Volume
Split â‡ (âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŸœ','âŠ¸âŠ”

Load â‡ {
  lines â† â€¢FLines ğ•©
  rows â† SplitÂ¨ 3â†“lines
  ! âˆ§Â´6â‰¤â‰ Â¨rows
  dates â‡ 0âŠ¸âŠ‘Â¨ rows
  close â‡ â€¢ParseFloatÂ¨ 1âŠ¸âŠ‘Â¨ rows
  high  â‡ â€¢ParseFloatÂ¨ 2âŠ¸âŠ‘Â¨ rows
  low   â‡ â€¢ParseFloatÂ¨ 3âŠ¸âŠ‘Â¨ rows
  open  â‡ â€¢ParseFloatÂ¨ 4âŠ¸âŠ‘Â¨ rows
  vol   â‡ â€¢ParseFloatÂ¨ 5âŠ¸âŠ‘Â¨ rows
}

# ğ•¨: 1 = strict/equity (default), 0 = futures (allows negative prices)
Validate â‡ {
  ğ•Š ğ•©: 1 ğ•Š ğ•©;
  s â† ğ•¨ â‹„ d â† ğ•©
  ! 0<â‰ d.close
  n â† â‰ d.close
  ! n=â‰ d.high
  ! n=â‰ d.low
  ! n=â‰ d.open
  ! n=â‰ d.vol
  # NOTE: NaNâ‰ NaN in IEEE 754, Inf detected via comparison
  ! âˆ§Â´(d.close=d.close)âˆ§Â¬âˆ=|d.close
  ! âˆ§Â´(d.high=d.high)âˆ§Â¬âˆ=|d.high
  ! âˆ§Â´(d.low=d.low)âˆ§Â¬âˆ=|d.low
  ! âˆ§Â´(d.open=d.open)âˆ§Â¬âˆ=|d.open
  ! âˆ§Â´d.volâ‰¥0
  { s ?
    ! âˆ§Â´d.close>0 â‹„ ! âˆ§Â´d.high>0 â‹„ ! âˆ§Â´d.low>0 â‹„ ! âˆ§Â´d.open>0
  ; @}
  ! âˆ§Â´d.highâ‰¥d.low
  ! âˆ§Â´d.highâ‰¥d.close
  ! âˆ§Â´d.highâ‰¥d.open
  ! âˆ§Â´d.lowâ‰¤d.close
  ! âˆ§Â´d.lowâ‰¤d.open
  d
}

Align â‡ {mâ†âŒŠÂ´â‰ Â¨ğ•© â‹„ (-m)â†‘Â¨ğ•©}

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Wilder smoothing (EMA with Î±=1/n). Used by RSI and ATR.
Wilder â‡ {aâ†Ã·ğ•¨ â‹„ (âŠ‘ğ•©){(aÃ—ğ•©)+(1-a)Ã—ğ•¨}`ğ•©}

# Population std (used by Sharpe, AnnVol, Skew, Kurt)
Pstd â‡ {mâ†(+Â´Ã·â‰ )ğ•© â‹„ âˆš(+Â´(ğ•©-m)â‹†2)Ã·â‰ ğ•©}

# â”€â”€ Indicators â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# n RMax prices â€” rolling maximum
RMax â‡ {âŒˆÂ´Ë˜ ğ•¨â†•ğ•©}

# n RMin prices â€” rolling minimum
RMin â‡ {âŒŠÂ´Ë˜ ğ•¨â†•ğ•©}

# n MA prices â€” simple moving average, O(n) via prefix-sum
MA â‡ {
  cs â† 0âˆ¾+`ğ•©
  ((ğ•¨â†“cs) - ((-ğ•¨)â†“cs)) Ã· ğ•¨
}

# n EMA prices â€” exponential moving average, same length as input
EMA â‡ {
  a â† 2Ã·1+ğ•¨
  (âŠ‘ğ•©) {(aÃ—ğ•©)+(1-a)Ã—ğ•¨}` ğ•©
}

# n WMA prices â€” weighted moving average
WMA â‡ {
  w â† 1+â†•ğ•¨
  {(+Â´wÃ—ğ•©)Ã·+Â´w}Ë˜ ğ•¨â†•ğ•©
}

# n Std prices â€” rolling population standard deviation, O(n) via prefix-sum
Std â‡ {
  s1 â† 0âˆ¾+`ğ•©
  s2 â† 0âˆ¾+`ğ•©â‹†2
  n â† ğ•¨
  m â† ((nâ†“s1) - ((-n)â†“s1)) Ã· n
  v â† ((nâ†“s2) - ((-n)â†“s2)) Ã· n
  âˆš 0âŒˆ v - mâ‹†2
}

# n Mom prices â€” momentum (price difference)
Mom â‡ {(ğ•¨â†“ğ•©) - ((-ğ•¨)â†“ğ•©)}

# n ROC prices â€” rate of change as percentage
ROC â‡ {100 Ã— ((ğ•¨â†“ğ•©) - ((-ğ•¨)â†“ğ•©)) Ã· (-ğ•¨)â†“ğ•©}

# n RSI prices â€” relative strength index (0-100)
RSI â‡ {
  deltas â† 1â†“ ğ•© - Â»ğ•©
  gains â† 0âŒˆdeltas
  losses â† 0âŒˆ-deltas
  ag â† ğ•¨ Wilder gains
  al â† ğ•¨ Wilder losses
  # FIX: constant prices â†’ both ag and al near zero â†’ return 50 (neutral)
  flat â† (ag<eps) âˆ§ al<eps
  (50Ã—flat) + (Â¬flat) Ã— 100 - 100Ã·1+agÃ·alâŒˆeps
}

# fastâ€¿slowâ€¿sig MACD prices â†’ macdâ€¿signalâ€¿hist
MACD â‡ {
  fastâ€¿slowâ€¿sig â† ğ•¨
  ml â† (fast EMA ğ•©) - slow EMA ğ•©
  sl â† sig EMA ml
  mlâ€¿slâ€¿(ml-sl)
}

# n ATR data â€” average true range, takes namespace {high,low,close}
ATR â‡ {
  h â† ğ•©.high â‹„ l â† ğ•©.low â‹„ c â† ğ•©.close
  hl â† h-l
  hc â† |h - Â»c
  lc â† |l - Â»c
  tr â† hlâŒˆhcâŒˆlc
  1â†“ ğ•¨ Wilder tr
}

# n Stoch data â†’ kâ€¿d â€” stochastic oscillator
Stoch â‡ {
  c â† ğ•©.close â‹„ h â† ğ•©.high â‹„ l â† ğ•©.low
  lo â† ğ•¨ RMin l
  hi â† ğ•¨ RMax h
  rng â† hi - lo
  # NOTE: align close to window output (drop n-1 warmup bars)
  k â† 100 Ã— (((ğ•¨-1)â†“c)-lo) Ã· rngâŒˆeps
  d â† 3 MA k
  kâ€¿d
}

# nâ€¿k BB prices â†’ upperâ€¿midâ€¿lower â€” Bollinger Bands
BB â‡ {
  nâ€¿k â† ğ•¨
  mid â† n MA ğ•©
  sd â† n Std ğ•©
  (mid+kÃ—sd)â€¿midâ€¿(mid-kÃ—sd)
}

# OBV closeâ€¿vol â€” on-balance volume (monadic)
OBV â‡ {
  câ€¿v â† ğ•©
  signs â† Ã— -âŸœÂ» c
  # FIX: zero bar 0 â€” Â» fills with 0, making sign(close[0]-0) always positive
  +` (0âˆ¾1â†“signs) Ã— v
}

# VWAP data â€” volume-weighted average price (monadic, takes namespace)
VWAP â‡ {
  tp â† (ğ•©.high + ğ•©.low + ğ•©.close) Ã· 3
  (+`tpÃ—ğ•©.vol) Ã· (+`ğ•©.vol)âŒˆeps
}

# AD data â€” accumulation/distribution line (monadic, takes namespace)
AD â‡ {
  hâ†ğ•©.high â‹„ lâ†ğ•©.low â‹„ câ†ğ•©.close â‹„ vâ†ğ•©.vol
  rng â† h-l
  mfm â† ((c-l)-(h-c)) Ã· rngâŒˆeps
  +` mfm Ã— v
}

# â”€â”€ Signal Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# fast Cross slow â€” 1 where fast crosses above slow
# NOTE: bar 0 is always 0 â€” Â» fills with 0, so (0<0) is false
Cross â‡ {(ğ•¨â‰¥ğ•©) âˆ§ (Â»ğ•¨)<Â»ğ•©}

# fast CrossDown slow â€” 1 where fast crosses below slow
# NOTE: bar 0 is always 0 â€” Â» fills with 0, so (0>0) is false
CrossDown â‡ {(ğ•¨â‰¤ğ•©) âˆ§ (Â»ğ•¨)>Â»ğ•©}

# n Mask arr â€” zero first n elements, same length
Mask â‡ {(ğ•¨â¥Š0)âˆ¾ğ•¨â†“ğ•©}

# Fill signals â€” forward-fill: hold last non-zero
Fill â‡ {(âŠ‘ğ•©){ğ•©+(ğ•©=0)Ã—ğ•¨}`ğ•©}

# level Thresh values â€” 1 where value crosses above level
Thresh â‡ {(ğ•©>ğ•¨) âˆ§ (Â»ğ•©)â‰¤ğ•¨}

# level ThreshDown values â€” 1 where value crosses below level
ThreshDown â‡ {(ğ•©<ğ•¨) âˆ§ (Â»ğ•©)â‰¥ğ•¨}

# n Hold positions â€” min n-bar holding period
Hold â‡ {
  n â† ğ•¨ â‹„ pos â† 0 â‹„ count â† 0
  {
    count>0 ? count-â†©1 â‹„ pos;
    ğ•©â‰ pos  ? countâ†©(ğ•©â‰ 0)Ã—n-1 â‹„ posâ†©ğ•©;
    pos
  }Â¨ ğ•©
}
