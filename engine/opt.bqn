# bbq â€” BQN Based Quant
# engine/opt.bqn â€” Black-Scholes options pricing

core â† â€¢Import "core.bqn"
eps â† core.eps

# â”€â”€ Normal Distribution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Standard normal PDF
Npdf â‡ {(Ã·âˆš2Ã—Ï€) Ã— â‹†-0.5Ã—ğ•©â‹†2}

# Standard normal CDF (Abramowitz-Stegun approximation)
Phi â‡ {
  neg â† ğ•© < 0
  ax â† |ğ•©
  t â† Ã· 1 + 0.2316419Ã—ax
  # Horner: tÃ—(a1 + tÃ—(a2 + tÃ—(a3 + tÃ—(a4 + tÃ—a5))))
  poly â† t Ã— 0.319381530 + t Ã— Â¯0.356563782 + t Ã— 1.781477937 + t Ã— Â¯1.821255978 + t Ã— 1.330274429
  pos â† 1 - poly Ã— Npdf ax
  # Branchless: neg selects 1-pos, else pos
  ((Â¬neg) Ã— pos) + neg Ã— (1-pos)
}

# PhiInv p â†’ inverse standard normal CDF (Newton-Raphson + rational initial guess)
PhiInv â‡ {
  p â† 0.0001âŒˆ0.9999âŒŠğ•©
  t â† âˆš-2Ã—â‹†â¼(pâŒŠ1-p)
  num â† 2.515517 + 0.802853Ã—t + 0.010328Ã—tâ‹†2
  den â† 1 + 1.432788Ã—t + 0.189269Ã—tâ‹†2 + 0.001308Ã—tâ‹†3
  x0 â† t - numÃ·den
  x0 â†© {p<0.5 ? -x0 ; x0}
  Refine â† {ğ•© - ((Phi ğ•©)-p) Ã· epsâŒˆNpdf ğ•©}
  RefineâŸ5 x0
}

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# d1, d2, ÏƒâˆšT (internal)
D12 â† {
  sâ€¿kâ€¿ttâ€¿râ€¿v â† ğ•©
  st â† v Ã— âˆštt
  d1 â† ((â‹†â¼sÃ·k) + (r + 0.5Ã—vâ‹†2) Ã— tt) Ã· epsâŒˆst
  d2 â† d1 - st
  d1â€¿d2â€¿st
}

# â”€â”€ Pricing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# BS Sâ€¿Kâ€¿Tâ€¿râ€¿Ïƒâ€¿type â†’ price (type: 1=call, Â¯1=put)
BS â‡ {
  sâ€¿kâ€¿ttâ€¿râ€¿vâ€¿ty â† ğ•©
  d1â€¿d2â€¿st â† D12 sâ€¿kâ€¿ttâ€¿râ€¿v
  df â† â‹†-rÃ—tt
  (tyÃ—sÃ—Phi tyÃ—d1) - tyÃ—kÃ—dfÃ—Phi tyÃ—d2
}

# â”€â”€ Greeks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Delta â‡ {
  sâ€¿kâ€¿ttâ€¿râ€¿vâ€¿ty â† ğ•©
  d1â€¿d2â€¿st â† D12 sâ€¿kâ€¿ttâ€¿râ€¿v
  (Phi d1) + (ty-1)Ã·2
}

Gamma â‡ {
  sâ€¿kâ€¿ttâ€¿râ€¿vâ€¿ty â† ğ•©
  d1â€¿d2â€¿st â† D12 sâ€¿kâ€¿ttâ€¿râ€¿v
  (Npdf d1) Ã· (s Ã— epsâŒˆst)
}

Theta â‡ {
  sâ€¿kâ€¿ttâ€¿râ€¿vâ€¿ty â† ğ•©
  d1â€¿d2â€¿st â† D12 sâ€¿kâ€¿ttâ€¿râ€¿v
  df â† â‹†-rÃ—tt
  t1 â† (s Ã— (Npdf d1) Ã— v) Ã· epsâŒˆ2Ã—âˆštt
  t2 â† ty Ã— r Ã— k Ã— df Ã— Phi tyÃ—d2
  (-t1) - t2
}

Vega â‡ {
  sâ€¿kâ€¿ttâ€¿râ€¿vâ€¿ty â† ğ•©
  d1â€¿d2â€¿st â† D12 sâ€¿kâ€¿ttâ€¿râ€¿v
  s Ã— (Npdf d1) Ã— âˆštt
}

Rho â‡ {
  sâ€¿kâ€¿ttâ€¿râ€¿vâ€¿ty â† ğ•©
  d1â€¿d2â€¿st â† D12 sâ€¿kâ€¿ttâ€¿râ€¿v
  df â† â‹†-rÃ—tt
  ty Ã— k Ã— tt Ã— df Ã— Phi tyÃ—d2
}

# â”€â”€ Implied Volatility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# IV targetâ€¿Sâ€¿Kâ€¿Tâ€¿râ€¿type â†’ Ïƒ (Newton-Raphson)
IV â‡ {
  targetâ€¿sâ€¿kâ€¿ttâ€¿râ€¿ty â† ğ•©
  Step â† {
    sig â† 0.001âŒˆ10âŒŠğ•©
    price â† BS sâ€¿kâ€¿ttâ€¿râ€¿sigâ€¿ty
    vega â† Vega sâ€¿kâ€¿ttâ€¿râ€¿sigâ€¿ty
    0.001âŒˆ10âŒŠ sig - (price-target) Ã· epsâŒˆvega
  }
  StepâŸ100 0.5
}

# â”€â”€ Parity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Parity Sâ€¿Kâ€¿Tâ€¿r â†’ S - Ke^(-rT) (put-call parity forward)
Parity â‡ {
  sâ€¿kâ€¿ttâ€¿r â† ğ•©
  s - k Ã— â‹†-rÃ—tt
}
