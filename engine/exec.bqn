# bbq â€” BQN Based Quant
# engine/exec.bqn â€” execution realism: slippage, stops, limits

bt â† â€¢Import "bt.bqn"

# â”€â”€ Slippage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# rateâ€¿adv_frac Slippage posâ€¿vol â†’ cost array
# Almgren-Chriss sqrt model: cost = rate Ã— âˆš(|Î”pos| / (adv_frac Ã— vol))
Slippage â‡ {
  rateâ€¿adv_frac â† ğ•¨
  posâ€¿vol â† ğ•©
  delta â† |-âŸœÂ»pos
  rate Ã— âˆšdelta Ã· (adv_frac Ã— vol)âŒˆbt.eps
}

# â”€â”€ Fill Limit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# adv_frac FillLimit posâ€¿vol â†’ position clipped to adv_frac Ã— vol
FillLimit â‡ {
  adv_frac â† ğ•¨
  posâ€¿vol â† ğ•©
  cap â† adv_frac Ã— vol
  (Ã—pos) Ã— cap âŒŠ |pos
}

# â”€â”€ Scale â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# arr Scale pos â†’ arr Ã— pos
Scale â‡ Ã—

# â”€â”€ Stop Loss â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# pct StopLoss posâ€¿data â†’ {pos, ret, triggered}
# Long exit if low[i] < entry_price Ã— (1-pct); fill at stop price
# entry_price = open of bar when entering position
StopLoss â‡ {
  pct â† ğ•¨
  posâ€¿data â† ğ•©
  n â† â‰ pos
  o â† data.open â‹„ l â† data.low â‹„ c â† data.close

  bar_ret â† (c-o) Ã· oâŒˆbt.eps

  out_pos â† +pos
  out_ret â† +bar_ret
  out_trig â† 0Â¨pos
  entry_px â† 0.0

  {
    i â† ğ•©
    p â† iâŠ‘pos
    { p > 0 ?
      { (i=0) âˆ¨ (0 = (i-1)âŠ‘pos) ? entry_px â†© iâŠ‘o ; @ }
      stop_px â† entry_px Ã— 1-pct
      { (iâŠ‘l) < stop_px ?
        out_pos  â†© 0 âŒ¾ (iâŠ¸âŠ‘) out_pos
        out_trig â†© 1 âŒ¾ (iâŠ¸âŠ‘) out_trig
        sr â† (stop_px - iâŠ‘o) Ã· (iâŠ‘o)âŒˆbt.eps
        out_ret  â†© sr âŒ¾ (iâŠ¸âŠ‘) out_ret
        entry_px â†© 0.0
      ; @ }
    ;
      entry_px â†© 0.0
    }
    @
  }Â¨ â†•n

  # NOTE: use original pos for ret so triggered bar contributes stop_ret
  sret â† posÃ—out_ret
  {posâ‡out_pos, retâ‡sret, triggeredâ‡out_trig}
}

# â”€â”€ Take Profit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# pct TakeProfit posâ€¿data â†’ {pos, ret, triggered}
# Long exit if high[i] > entry_price Ã— (1+pct); fill at target price
TakeProfit â‡ {
  pct â† ğ•¨
  posâ€¿data â† ğ•©
  n â† â‰ pos
  o â† data.open â‹„ h â† data.high â‹„ c â† data.close

  bar_ret â† (c-o) Ã· oâŒˆbt.eps

  out_pos â† +pos
  out_ret â† +bar_ret
  out_trig â† 0Â¨pos
  entry_px â† 0.0

  {
    i â† ğ•©
    p â† iâŠ‘pos
    { p > 0 ?
      { (i=0) âˆ¨ (0 = (i-1)âŠ‘pos) ? entry_px â†© iâŠ‘o ; @ }
      tp_px â† entry_px Ã— 1+pct
      { (iâŠ‘h) > tp_px ?
        out_pos  â†© 0 âŒ¾ (iâŠ¸âŠ‘) out_pos
        out_trig â†© 1 âŒ¾ (iâŠ¸âŠ‘) out_trig
        tr â† (tp_px - iâŠ‘o) Ã· (iâŠ‘o)âŒˆbt.eps
        out_ret  â†© tr âŒ¾ (iâŠ¸âŠ‘) out_ret
        entry_px â†© 0.0
      ; @ }
    ;
      entry_px â†© 0.0
    }
    @
  }Â¨ â†•n

  sret â† posÃ—out_ret
  {posâ‡out_pos, retâ‡sret, triggeredâ‡out_trig}
}

# â”€â”€ Stop + Take Profit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# slâ€¿tp StopTake posâ€¿data â†’ {pos, ret, triggered}
# Combined stop loss and take profit. Stop wins on same-bar conflict.
# triggered encoding: 0=none, 1=stop, 2=tp, 3=both (stop wins)
StopTake â‡ {
  slâ€¿tp â† ğ•¨
  posâ€¿data â† ğ•©
  n â† â‰ pos
  o â† data.open â‹„ h â† data.high â‹„ l â† data.low â‹„ c â† data.close

  bar_ret â† (c-o) Ã· oâŒˆbt.eps

  out_pos â† +pos
  out_ret â† +bar_ret
  out_trig â† 0Â¨pos
  entry_px â† 0.0

  {
    i â† ğ•©
    p â† iâŠ‘pos
    { p > 0 ?
      { (i=0) âˆ¨ (0 = (i-1)âŠ‘pos) ? entry_px â†© iâŠ‘o ; @ }
      stop_px â† entry_px Ã— 1-sl
      tp_px   â† entry_px Ã— 1+tp
      sl_hit â† (iâŠ‘l) < stop_px
      tp_hit â† (iâŠ‘h) > tp_px
      { sl_hit âˆ¨ tp_hit ?
        fill_px â† { sl_hit ? stop_px ; tp_px }
        out_pos  â†© 0 âŒ¾ (iâŠ¸âŠ‘) out_pos
        out_trig â†© (sl_hit + 2Ã—tp_hit) âŒ¾ (iâŠ¸âŠ‘) out_trig
        fr â† (fill_px - iâŠ‘o) Ã· (iâŠ‘o)âŒˆbt.eps
        out_ret  â†© fr âŒ¾ (iâŠ¸âŠ‘) out_ret
        entry_px â†© 0.0
      ; @ }
    ;
      entry_px â†© 0.0
    }
    @
  }Â¨ â†•n

  sret â† posÃ—out_ret
  {posâ‡out_pos, retâ‡sret, triggeredâ‡out_trig}
}
