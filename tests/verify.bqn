# bbq â€” test suite
# tests/verify.bqn

bt â† â€¢Import "../engine/bt.bqn"

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Assert arrays approximately equal (tolerance 1e-6)
Ae â† {! âˆ§Â´ 1eÂ¯6 > | (â¥Šğ•¨)-(â¥Šğ•©)}

# Assert scalar approximately equal
As â† {! 1eÂ¯6 > |ğ•¨-ğ•©}

pass â† 0

â€¢Out "Running bbq test suite..."
â€¢Out ""

# â•â• Data â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

data â† bt.Load "../tests/fixture.csv"
! 5 = â‰ data.close
! 5 = â‰ data.high
! 5 = â‰ data.low
! 5 = â‰ data.open
! 5 = â‰ data.vol
! 5 = â‰ data.dates
100â€¿102â€¿101â€¿105â€¿103 Ae data.close
105â€¿107â€¿104â€¿108â€¿106 Ae data.high
95â€¿99â€¿98â€¿100â€¿97 Ae data.low
98â€¿100â€¿102â€¿101â€¿105 Ae data.open
1e6â€¿1.2e6â€¿9e5â€¿1.5e6â€¿1.1e6 Ae data.vol

pass +â†© 1 â‹„ â€¢Out "  PASS  Load"

# â”€â”€ Validate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

d â† bt.Validate data
! 5 = â‰ d.close

# Should fail on empty data
! 1 = ({bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡âŸ¨âŸ© â‹„ closeâ‡âŸ¨âŸ© â‹„ highâ‡âŸ¨âŸ© â‹„ lowâ‡âŸ¨âŸ© â‹„ openâ‡âŸ¨âŸ© â‹„ volâ‡âŸ¨âŸ©
}

# Should fail on negative prices
! 1 = ({bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡âŸ¨"a"âŸ© â‹„ closeâ‡âŸ¨Â¯1âŸ© â‹„ highâ‡âŸ¨5âŸ© â‹„ lowâ‡âŸ¨1âŸ© â‹„ openâ‡âŸ¨3âŸ© â‹„ volâ‡âŸ¨100âŸ©
}

# Should fail on OHLC violation (high < low)
! 1 = ({bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡âŸ¨"a"âŸ© â‹„ closeâ‡âŸ¨3âŸ© â‹„ highâ‡âŸ¨1âŸ© â‹„ lowâ‡âŸ¨5âŸ© â‹„ openâ‡âŸ¨3âŸ© â‹„ volâ‡âŸ¨100âŸ©
}

# Should fail on open outside high/low range
! 1 = ({bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡âŸ¨"a"âŸ© â‹„ closeâ‡âŸ¨3âŸ© â‹„ highâ‡âŸ¨5âŸ© â‹„ lowâ‡âŸ¨1âŸ© â‹„ openâ‡âŸ¨10âŸ© â‹„ volâ‡âŸ¨100âŸ©
}

# Should fail on length mismatch
! 1 = ({bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡"a"â€¿"b" â‹„ closeâ‡100â€¿102 â‹„ highâ‡âŸ¨105âŸ© â‹„ lowâ‡95â€¿99 â‹„ openâ‡98â€¿100 â‹„ volâ‡1000â€¿2000
}

pass +â†© 1 â‹„ â€¢Out "  PASS  Validate"

# â”€â”€ Align â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

r â† bt.Align âŸ¨1â€¿2â€¿3â€¿4â€¿5, 3â€¿4â€¿5âŸ©
3â€¿4â€¿5 Ae 0âŠ‘r
3â€¿4â€¿5 Ae 1âŠ‘r

r â†© bt.Align âŸ¨10â€¿20, 1â€¿2â€¿3â€¿4âŸ©
10â€¿20 Ae 0âŠ‘r
3â€¿4 Ae 1âŠ‘r

# Three arrays
r â†© bt.Align âŸ¨1â€¿2â€¿3, 1â€¿2â€¿3â€¿4, 1â€¿2â€¿3â€¿4â€¿5âŸ©
! 3 = â‰  0âŠ‘r
! 3 = â‰  1âŠ‘r
! 3 = â‰  2âŠ‘r

# Equal-length arrays pass through unchanged
r â†© bt.Align âŸ¨1â€¿2â€¿3, 4â€¿5â€¿6âŸ©
1â€¿2â€¿3 Ae 0âŠ‘r
4â€¿5â€¿6 Ae 1âŠ‘r

pass +â†© 1 â‹„ â€¢Out "  PASS  Align"

# â•â• Indicators â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

x â† 1â€¿3â€¿2â€¿5â€¿4
c â† data.close  # 100â€¿102â€¿101â€¿105â€¿103

# â”€â”€ MA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

101â€¿101.5â€¿103â€¿104 Ae 2 bt.MA c
2â€¿2.5â€¿3.5â€¿4.5 Ae 2 bt.MA x
! 3 = â‰  3 bt.MA x

pass +â†© 1 â‹„ â€¢Out "  PASS  MA"

# â”€â”€ EMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ema â† 2 bt.EMA x
! 5 = â‰ ema
(âŠ‘x) As âŠ‘ema
# EMA converges toward recent values
! (Â¯1âŠ‘ema) > 2

pass +â†© 1 â‹„ â€¢Out "  PASS  EMA"

# â”€â”€ WMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

(7Ã·3)â€¿(7Ã·3)â€¿4â€¿(13Ã·3) Ae 2 bt.WMA x
! 4 = â‰  2 bt.WMA x

pass +â†© 1 â‹„ â€¢Out "  PASS  WMA"

# â”€â”€ RMax â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3â€¿3â€¿5â€¿5 Ae 2 bt.RMax x
! 4 = â‰  2 bt.RMax x

pass +â†© 1 â‹„ â€¢Out "  PASS  RMax"

# â”€â”€ RMin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1â€¿2â€¿2â€¿4 Ae 2 bt.RMin x
! 4 = â‰  2 bt.RMin x

pass +â†© 1 â‹„ â€¢Out "  PASS  RMin"

# â”€â”€ Std â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1â€¿0.5â€¿1.5â€¿0.5 Ae 2 bt.Std x
! 4 = â‰  2 bt.Std x

pass +â†© 1 â‹„ â€¢Out "  PASS  Std"

# â”€â”€ Mom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2â€¿Â¯1â€¿3â€¿Â¯1 Ae 1 bt.Mom x
1â€¿2â€¿2 Ae 2 bt.Mom x

pass +â†© 1 â‹„ â€¢Out "  PASS  Mom"

# â”€â”€ ROC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

200â€¿(100Ã—Â¯1Ã·3)â€¿150â€¿Â¯20 Ae 1 bt.ROC x
! 4 = â‰  1 bt.ROC x

pass +â†© 1 â‹„ â€¢Out "  PASS  ROC"

# â”€â”€ RSI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

rsi â† 14 bt.RSI c
! âˆ§Â´ (rsiâ‰¥0) âˆ§ rsiâ‰¤100
# Strictly rising prices â†’ RSI high
rsi_up â† 3 bt.RSI 1â€¿2â€¿3â€¿4â€¿5â€¿6â€¿7â€¿8
! âˆ§Â´ (2â†“rsi_up) > 50

pass +â†© 1 â‹„ â€¢Out "  PASS  RSI"

# â”€â”€ MACD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

mlâ€¿slâ€¿hist â† 2â€¿3â€¿2 bt.MACD c
! (â‰ ml) = â‰ c
! (â‰ sl) = â‰ c
! (â‰ hist) = â‰ c
(ml-sl) Ae hist

pass +â†© 1 â‹„ â€¢Out "  PASS  MACD"

# â”€â”€ ATR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

atr â† 2 bt.ATR data
! (Â¯1+â‰ c) = â‰ atr
! âˆ§Â´ atr > 0

pass +â†© 1 â‹„ â€¢Out "  PASS  ATR"

# â”€â”€ Stoch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

kâ€¿kd â† 2 bt.Stoch data
! âˆ§Â´ (kâ‰¥0) âˆ§ kâ‰¤100

pass +â†© 1 â‹„ â€¢Out "  PASS  Stoch"

# â”€â”€ BB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

uâ€¿mâ€¿l â† 2â€¿1 bt.BB x
! âˆ§Â´ u â‰¥ m
! âˆ§Â´ m â‰¥ l
2â€¿2.5â€¿3.5â€¿4.5 Ae m
! 4 = â‰ u

pass +â†© 1 â‹„ â€¢Out "  PASS  BB"

# â”€â”€ OBV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

obv â† bt.OBV câ€¿data.vol
! (â‰ c) = â‰ obv
# First bar: sign of (100-0) is positive â†’ vol added
! (âŠ‘obv) = âŠ‘data.vol

pass +â†© 1 â‹„ â€¢Out "  PASS  OBV"

# â”€â”€ VWAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

vwap â† bt.VWAP data
! (â‰ c) = â‰ vwap
# VWAP is a weighted average of typical price, bounded by cumulative extremes
! âˆ§Â´ vwap > 0

pass +â†© 1 â‹„ â€¢Out "  PASS  VWAP"

# â”€â”€ AD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ad â† bt.AD data
! (â‰ c) = â‰ ad

pass +â†© 1 â‹„ â€¢Out "  PASS  AD"

# â•â• Signal Utilities â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ Cross â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿0â€¿1â€¿0 Ae (1â€¿0â€¿1â€¿1) bt.Cross (0â€¿1â€¿0â€¿0)

pass +â†© 1 â‹„ â€¢Out "  PASS  Cross"

# â”€â”€ CrossDown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿1â€¿0â€¿0 Ae (1â€¿0â€¿1â€¿1) bt.CrossDown (0â€¿1â€¿0â€¿0)

pass +â†© 1 â‹„ â€¢Out "  PASS  CrossDown"

# â”€â”€ Mask â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿0â€¿3â€¿4â€¿5 Ae 2 bt.Mask 1â€¿2â€¿3â€¿4â€¿5
! 5 = â‰  2 bt.Mask 1â€¿2â€¿3â€¿4â€¿5

pass +â†© 1 â‹„ â€¢Out "  PASS  Mask"

# â”€â”€ Fill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿1â€¿1â€¿1â€¿Â¯1â€¿Â¯1 Ae bt.Fill 0â€¿1â€¿0â€¿0â€¿Â¯1â€¿0
# Starting with non-zero
3â€¿3â€¿2â€¿2 Ae bt.Fill 3â€¿0â€¿2â€¿0

pass +â†© 1 â‹„ â€¢Out "  PASS  Fill"

# â”€â”€ Thresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿0â€¿1â€¿0â€¿0 Ae 30 bt.Thresh 25â€¿28â€¿35â€¿32â€¿29

pass +â†© 1 â‹„ â€¢Out "  PASS  Thresh"

# â”€â”€ ThreshDown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿0â€¿1â€¿0â€¿0 Ae 30 bt.ThreshDown 35â€¿32â€¿25â€¿28â€¿31

pass +â†© 1 â‹„ â€¢Out "  PASS  ThreshDown"

# â”€â”€ Hold â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿1â€¿1â€¿1â€¿0â€¿Â¯1 Ae 3 bt.Hold 0â€¿1â€¿0â€¿0â€¿0â€¿Â¯1
# No holding needed when already in position
1â€¿1â€¿1 Ae 2 bt.Hold 1â€¿1â€¿1

pass +â†© 1 â‹„ â€¢Out "  PASS  Hold"

# â•â• Simulation â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ _Sim â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Echo step: position = observation
result â† {âŸ¨ğ•©âŸ©} bt._Sim âŸ¨0âŸ©â€¿(1â€¿0â€¿1â€¿Â¯1â€¿0)
1â€¿0â€¿1â€¿Â¯1â€¿0 Ae result

# Accumulator step: state = âŸ¨sum, countâŸ©, position = running sum
result2 â† {âŸ¨(âŠ‘ğ•¨)+ğ•©, (1âŠ‘ğ•¨)+1âŸ©} bt._Sim âŸ¨0,0âŸ©â€¿(1â€¿2â€¿3)
1â€¿3â€¿6 Ae result2

pass +â†© 1 â‹„ â€¢Out "  PASS  _Sim"

# â•â• Backtest Core â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ Ret â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ret â† bt.Ret c
! 4 = â‰ ret
(0.02) As âŠ‘ret
# Second return: (101-102)/102
(Â¯1Ã·102) As 1âŠ‘ret

pass +â†© 1 â‹„ â€¢Out "  PASS  Ret"

# â”€â”€ LogRet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

lr â† bt.LogRet c
! 4 = â‰ lr
# LogRet â‰ˆ Ret for small returns
! âˆ§Â´ 0.001 > |lr - ret

pass +â†© 1 â‹„ â€¢Out "  PASS  LogRet"

# â”€â”€ Run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

sr â† 1â€¿0â€¿1â€¿Â¯1 bt.Run 0.02â€¿Â¯0.01â€¿0.03â€¿Â¯0.02
0.02â€¿0â€¿0.03â€¿0.02 Ae sr

pass +â†© 1 â‹„ â€¢Out "  PASS  Run"

# â”€â”€ Cost â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

costs â† 0.001 bt.Cost 0â€¿1â€¿1â€¿0â€¿Â¯1
0â€¿0.001â€¿0â€¿0.001â€¿0.001 Ae costs

pass +â†© 1 â‹„ â€¢Out "  PASS  Cost"

# â”€â”€ Equity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

eq â† bt.Equity 0.1â€¿Â¯0.05â€¿0.02
! 3 = â‰ eq
1.1 As âŠ‘eq
(1.1Ã—0.95) As 1âŠ‘eq
(1.1Ã—0.95Ã—1.02) As 2âŠ‘eq

pass +â†© 1 â‹„ â€¢Out "  PASS  Equity"

# â•â• Metrics â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Test returns for metrics
mr â† 0.02â€¿Â¯0.01â€¿0.03â€¿Â¯0.02â€¿0.01

# â”€â”€ TotalRet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tr â† bt.TotalRet mr
eq_final â† Â¯1âŠ‘bt.Equity mr
(eq_final - 1) As tr

pass +â†© 1 â‹„ â€¢Out "  PASS  TotalRet"

# â”€â”€ CAGR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cagr â† bt.CAGR mr
! cagr > 0  # net positive returns â†’ positive CAGR

pass +â†© 1 â‹„ â€¢Out "  PASS  CAGR"

# â”€â”€ AnnVol â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

vol â† bt.AnnVol mr
! vol > 0

pass +â†© 1 â‹„ â€¢Out "  PASS  AnnVol"

# â”€â”€ Sharpe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

sh â† bt.Sharpe mr
! sh > 0  # positive mean returns â†’ positive Sharpe
# Zero returns â†’ zero Sharpe
0 As bt.Sharpe 0â€¿0â€¿0â€¿0

pass +â†© 1 â‹„ â€¢Out "  PASS  Sharpe"

# â”€â”€ Sortino â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

so â† bt.Sortino mr
! so > 0
# Sortino â‰¥ Sharpe when there's downside
! so â‰¥ sh

pass +â†© 1 â‹„ â€¢Out "  PASS  Sortino"

# â”€â”€ MaxDD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

dd â† bt.MaxDD mr
! dd â‰¤ 0  # drawdown is non-positive
# All positive returns â†’ zero drawdown
0 As bt.MaxDD 0.01â€¿0.02â€¿0.03

pass +â†© 1 â‹„ â€¢Out "  PASS  MaxDD"

# â”€â”€ MaxDDDur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

dur â† bt.MaxDDDur mr
! dur â‰¥ 0
# All positive returns â†’ zero duration
0 As bt.MaxDDDur 0.01â€¿0.02â€¿0.03
# Single drawdown bar
1 As bt.MaxDDDur 0.1â€¿Â¯0.05â€¿0.1

pass +â†© 1 â‹„ â€¢Out "  PASS  MaxDDDur"

# â”€â”€ Calmar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cal â† bt.Calmar mr
! cal > 0

pass +â†© 1 â‹„ â€¢Out "  PASS  Calmar"

# â”€â”€ WinRate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

wr â† bt.WinRate mr
(3Ã·5) As wr  # 3 positive out of 5

pass +â†© 1 â‹„ â€¢Out "  PASS  WinRate"

# â”€â”€ ProfitFactor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

pf â† bt.ProfitFactor mr
# gross profit = 0.02+0.03+0.01 = 0.06, gross loss = 0.01+0.02 = 0.03
(0.06Ã·0.03) As pf

pass +â†© 1 â‹„ â€¢Out "  PASS  ProfitFactor"

# â”€â”€ AvgWin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

aw â† bt.AvgWin mr
((0.02+0.03+0.01)Ã·3) As aw

pass +â†© 1 â‹„ â€¢Out "  PASS  AvgWin"

# â”€â”€ AvgLoss â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

al â† bt.AvgLoss mr
((Â¯0.01+Â¯0.02)Ã·2) As al

pass +â†© 1 â‹„ â€¢Out "  PASS  AvgLoss"

# â”€â”€ Expectancy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ex â† bt.Expectancy mr
# wrÃ—avgwin + (1-wr)Ã—avgloss = 0.6Ã—0.02 + 0.4Ã—(-0.015) = 0.006
0.006 As ex

pass +â†© 1 â‹„ â€¢Out "  PASS  Expectancy"

# â”€â”€ Trades â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

pos_t â† 0â€¿1â€¿1â€¿0â€¿Â¯1
3 As bt.Trades pos_t

pass +â†© 1 â‹„ â€¢Out "  PASS  Trades"

# â”€â”€ TimeIn / Exposure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

(3Ã·5) As bt.TimeIn pos_t
(bt.TimeIn pos_t) As bt.Exposure pos_t

pass +â†© 1 â‹„ â€¢Out "  PASS  TimeIn/Exposure"

# â”€â”€ Skew â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Symmetric distribution â†’ skew = 0
0 As bt.Skew 1â€¿2â€¿3â€¿4â€¿5

pass +â†© 1 â‹„ â€¢Out "  PASS  Skew"

# â”€â”€ Kurt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Uniform-like â†’ negative excess kurtosis
kurt â† bt.Kurt 1â€¿2â€¿3â€¿4â€¿5
Â¯1.3 As kurt

pass +â†© 1 â‹„ â€¢Out "  PASS  Kurt"

# â•â• Portfolio â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ PortRun â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# 2 assets, equal weights, known returns
pr â† 0.5â€¿0.5 bt.PortRun âŸ¨âŸ¨1â€¿1â€¿1â€¿1, 0.02â€¿Â¯0.01â€¿0.03â€¿Â¯0.02âŸ©, âŸ¨1â€¿1â€¿1â€¿1, 0.01â€¿0.02â€¿Â¯0.01â€¿0.04âŸ©âŸ©
# Expected: 0.5Ã—0.02+0.5Ã—0.01, 0.5Ã—(Â¯0.01)+0.5Ã—0.02, ...
0.015â€¿0.005â€¿0.01â€¿0.01 Ae pr

pass +â†© 1 â‹„ â€¢Out "  PASS  PortRun"

# â”€â”€ PortRun weights assertion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

! 1 = ({ğ•© bt.PortRun âŸ¨âŸ¨1â€¿1, 0.01â€¿0.02âŸ©, âŸ¨1â€¿1, 0.03â€¿0.04âŸ©âŸ© â‹„ 0}âŠ{1}) 0.3â€¿0.3

pass +â†© 1 â‹„ â€¢Out "  PASS  PortRun weight assertion"

# â”€â”€ PortCost â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

pc â† 0.001â€¿0.002 bt.PortCost âŸ¨0â€¿1â€¿1â€¿0, 0â€¿0â€¿1â€¿Â¯1âŸ©
# Asset 0: 0.001Ã—|0,1,0,1| = 0,0.001,0,0.001
# Asset 1: 0.002Ã—|0,0,1,2| = 0,0,0.002,0.004
# Combined: 0, 0.001, 0.002, 0.005
0â€¿0.001â€¿0.002â€¿0.005 Ae pc

pass +â†© 1 â‹„ â€¢Out "  PASS  PortCost"

# â”€â”€ PortEquity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

peq â† bt.PortEquity 0.1â€¿Â¯0.05â€¿0.02
eq_ref â† bt.Equity 0.1â€¿Â¯0.05â€¿0.02
peq Ae eq_ref

pass +â†© 1 â‹„ â€¢Out "  PASS  PortEquity"

# â•â• Summary â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â€¢Out ""
â€¢Out "All " âˆ¾ (â€¢Fmt pass) âˆ¾ " tests passed"
