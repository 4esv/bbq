# bbq â€” BQN Based Quant â€” test suite
# tests/verify.bqn

bt â† â€¢Import "../engine/bt.bqn"

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Assert arrays approximately equal (tolerance 1e-6)
Ae â† {! âˆ§Â´ 1eÂ¯6 > | (â¥Šğ•¨)-(â¥Šğ•©)}

# Assert scalar approximately equal
As â† {! 1eÂ¯6 > |ğ•¨-ğ•©}

pass â† 0

â€¢Out "Running bbq test suite..."
â€¢Out ""

# â•â• Data â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

data â† bt.Load "../tests/fixture.csv"
! 5 = â‰ data.close
! 5 = â‰ data.high
! 5 = â‰ data.low
! 5 = â‰ data.open
! 5 = â‰ data.vol
! 5 = â‰ data.dates
100â€¿102â€¿101â€¿105â€¿103 Ae data.close
105â€¿107â€¿104â€¿108â€¿106 Ae data.high
95â€¿99â€¿98â€¿100â€¿97 Ae data.low
98â€¿100â€¿102â€¿101â€¿105 Ae data.open
1e6â€¿1.2e6â€¿9e5â€¿1.5e6â€¿1.1e6 Ae data.vol

pass +â†© 1 â‹„ â€¢Out "  PASS  Load"

# â”€â”€ Validate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

d â† bt.Validate data
! 5 = â‰ d.close

# Should fail on empty data
! 1 = ({bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡âŸ¨âŸ© â‹„ closeâ‡âŸ¨âŸ© â‹„ highâ‡âŸ¨âŸ© â‹„ lowâ‡âŸ¨âŸ© â‹„ openâ‡âŸ¨âŸ© â‹„ volâ‡âŸ¨âŸ©
}

# Should fail on negative prices in strict (default) mode
! 1 = ({bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡âŸ¨"a"âŸ© â‹„ closeâ‡âŸ¨Â¯1âŸ© â‹„ highâ‡âŸ¨5âŸ© â‹„ lowâ‡âŸ¨1âŸ© â‹„ openâ‡âŸ¨3âŸ© â‹„ volâ‡âŸ¨100âŸ©
}

# Should fail on negative prices in explicit strict mode
! 1 = ({1 bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡âŸ¨"a"âŸ© â‹„ closeâ‡âŸ¨Â¯1âŸ© â‹„ highâ‡âŸ¨5âŸ© â‹„ lowâ‡âŸ¨1âŸ© â‹„ openâ‡âŸ¨3âŸ© â‹„ volâ‡âŸ¨100âŸ©
}

# Futures mode: should accept negative prices
fd â† 0 bt.Validate {
  datesâ‡âŸ¨"a"âŸ© â‹„ closeâ‡âŸ¨Â¯37.63âŸ© â‹„ highâ‡âŸ¨Â¯30âŸ© â‹„ lowâ‡âŸ¨Â¯40âŸ© â‹„ openâ‡âŸ¨Â¯35âŸ© â‹„ volâ‡âŸ¨100âŸ©
}
! 1 = â‰ fd.close

# Futures mode: should still enforce OHLC relationships
! 1 = ({0 bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡âŸ¨"a"âŸ© â‹„ closeâ‡âŸ¨Â¯37âŸ© â‹„ highâ‡âŸ¨Â¯50âŸ© â‹„ lowâ‡âŸ¨Â¯30âŸ© â‹„ openâ‡âŸ¨Â¯35âŸ© â‹„ volâ‡âŸ¨100âŸ©
}

# Should fail on OHLC violation (high < low)
! 1 = ({bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡âŸ¨"a"âŸ© â‹„ closeâ‡âŸ¨3âŸ© â‹„ highâ‡âŸ¨1âŸ© â‹„ lowâ‡âŸ¨5âŸ© â‹„ openâ‡âŸ¨3âŸ© â‹„ volâ‡âŸ¨100âŸ©
}

# Should fail on open outside high/low range
! 1 = ({bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡âŸ¨"a"âŸ© â‹„ closeâ‡âŸ¨3âŸ© â‹„ highâ‡âŸ¨5âŸ© â‹„ lowâ‡âŸ¨1âŸ© â‹„ openâ‡âŸ¨10âŸ© â‹„ volâ‡âŸ¨100âŸ©
}

# Should fail on length mismatch
! 1 = ({bt.Validate ğ•© â‹„ 0}âŠ{1}) {
  datesâ‡"a"â€¿"b" â‹„ closeâ‡100â€¿102 â‹„ highâ‡âŸ¨105âŸ© â‹„ lowâ‡95â€¿99 â‹„ openâ‡98â€¿100 â‹„ volâ‡1000â€¿2000
}

pass +â†© 1 â‹„ â€¢Out "  PASS  Validate"

# â”€â”€ Align â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

r â† bt.Align âŸ¨1â€¿2â€¿3â€¿4â€¿5, 3â€¿4â€¿5âŸ©
3â€¿4â€¿5 Ae 0âŠ‘r
3â€¿4â€¿5 Ae 1âŠ‘r

r â†© bt.Align âŸ¨10â€¿20, 1â€¿2â€¿3â€¿4âŸ©
10â€¿20 Ae 0âŠ‘r
3â€¿4 Ae 1âŠ‘r

# Three arrays
r â†© bt.Align âŸ¨1â€¿2â€¿3, 1â€¿2â€¿3â€¿4, 1â€¿2â€¿3â€¿4â€¿5âŸ©
! 3 = â‰  0âŠ‘r
! 3 = â‰  1âŠ‘r
! 3 = â‰  2âŠ‘r

# Equal-length arrays pass through unchanged
r â†© bt.Align âŸ¨1â€¿2â€¿3, 4â€¿5â€¿6âŸ©
1â€¿2â€¿3 Ae 0âŠ‘r
4â€¿5â€¿6 Ae 1âŠ‘r

pass +â†© 1 â‹„ â€¢Out "  PASS  Align"

# â•â• Indicators â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

x â† 1â€¿3â€¿2â€¿5â€¿4
c â† data.close  # 100â€¿102â€¿101â€¿105â€¿103

# â”€â”€ MA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

101â€¿101.5â€¿103â€¿104 Ae 2 bt.MA c
2â€¿2.5â€¿3.5â€¿4.5 Ae 2 bt.MA x
! 3 = â‰  3 bt.MA x

pass +â†© 1 â‹„ â€¢Out "  PASS  MA"

# â”€â”€ EMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ema â† 2 bt.EMA x
! 5 = â‰ ema
(âŠ‘x) As âŠ‘ema
# EMA converges toward recent values
! (Â¯1âŠ‘ema) > 2

pass +â†© 1 â‹„ â€¢Out "  PASS  EMA"

# â”€â”€ WMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

(7Ã·3)â€¿(7Ã·3)â€¿4â€¿(13Ã·3) Ae 2 bt.WMA x
! 4 = â‰  2 bt.WMA x

pass +â†© 1 â‹„ â€¢Out "  PASS  WMA"

# â”€â”€ RMax â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3â€¿3â€¿5â€¿5 Ae 2 bt.RMax x
! 4 = â‰  2 bt.RMax x

pass +â†© 1 â‹„ â€¢Out "  PASS  RMax"

# â”€â”€ RMin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1â€¿2â€¿2â€¿4 Ae 2 bt.RMin x
! 4 = â‰  2 bt.RMin x

pass +â†© 1 â‹„ â€¢Out "  PASS  RMin"

# â”€â”€ Std â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1â€¿0.5â€¿1.5â€¿0.5 Ae 2 bt.Std x
! 4 = â‰  2 bt.Std x

pass +â†© 1 â‹„ â€¢Out "  PASS  Std"

# â”€â”€ Mom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2â€¿Â¯1â€¿3â€¿Â¯1 Ae 1 bt.Mom x
1â€¿2â€¿2 Ae 2 bt.Mom x

pass +â†© 1 â‹„ â€¢Out "  PASS  Mom"

# â”€â”€ ROC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

200â€¿(100Ã—Â¯1Ã·3)â€¿150â€¿Â¯20 Ae 1 bt.ROC x
! 4 = â‰  1 bt.ROC x

pass +â†© 1 â‹„ â€¢Out "  PASS  ROC"

# â”€â”€ RSI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

rsi â† 14 bt.RSI c
! âˆ§Â´ (rsiâ‰¥0) âˆ§ rsiâ‰¤100
# Strictly rising prices â†’ RSI high
rsi_up â† 3 bt.RSI 1â€¿2â€¿3â€¿4â€¿5â€¿6â€¿7â€¿8
! âˆ§Â´ (2â†“rsi_up) > 50

pass +â†© 1 â‹„ â€¢Out "  PASS  RSI"

# â”€â”€ MACD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

mlâ€¿slâ€¿hist â† 2â€¿3â€¿2 bt.MACD c
! (â‰ ml) = â‰ c
! (â‰ sl) = â‰ c
! (â‰ hist) = â‰ c
(ml-sl) Ae hist

pass +â†© 1 â‹„ â€¢Out "  PASS  MACD"

# â”€â”€ ATR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

atr â† 2 bt.ATR data
! (Â¯1+â‰ c) = â‰ atr
! âˆ§Â´ atr > 0

pass +â†© 1 â‹„ â€¢Out "  PASS  ATR"

# â”€â”€ Stoch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

kâ€¿kd â† 2 bt.Stoch data
! âˆ§Â´ (kâ‰¥0) âˆ§ kâ‰¤100

pass +â†© 1 â‹„ â€¢Out "  PASS  Stoch"

# â”€â”€ BB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

uâ€¿mâ€¿l â† 2â€¿1 bt.BB x
! âˆ§Â´ u â‰¥ m
! âˆ§Â´ m â‰¥ l
2â€¿2.5â€¿3.5â€¿4.5 Ae m
! 4 = â‰ u

pass +â†© 1 â‹„ â€¢Out "  PASS  BB"

# â”€â”€ OBV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

obv â† bt.OBV câ€¿data.vol
! (â‰ c) = â‰ obv
# First bar has no prior close, so OBV starts at 0
0 As âŠ‘obv

pass +â†© 1 â‹„ â€¢Out "  PASS  OBV"

# â”€â”€ VWAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

vwap â† bt.VWAP data
! (â‰ c) = â‰ vwap
# VWAP is a weighted average of typical price, bounded by cumulative extremes
! âˆ§Â´ vwap > 0

pass +â†© 1 â‹„ â€¢Out "  PASS  VWAP"

# â”€â”€ AD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ad â† bt.AD data
! (â‰ c) = â‰ ad

pass +â†© 1 â‹„ â€¢Out "  PASS  AD"

# â•â• Signal Utilities â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ Cross â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿0â€¿1â€¿0 Ae (1â€¿0â€¿1â€¿1) bt.Cross (0â€¿1â€¿0â€¿0)

pass +â†© 1 â‹„ â€¢Out "  PASS  Cross"

# â”€â”€ CrossDown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿1â€¿0â€¿0 Ae (1â€¿0â€¿1â€¿1) bt.CrossDown (0â€¿1â€¿0â€¿0)

pass +â†© 1 â‹„ â€¢Out "  PASS  CrossDown"

# â”€â”€ Mask â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿0â€¿3â€¿4â€¿5 Ae 2 bt.Mask 1â€¿2â€¿3â€¿4â€¿5
! 5 = â‰  2 bt.Mask 1â€¿2â€¿3â€¿4â€¿5

pass +â†© 1 â‹„ â€¢Out "  PASS  Mask"

# â”€â”€ Fill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿1â€¿1â€¿1â€¿Â¯1â€¿Â¯1 Ae bt.Fill 0â€¿1â€¿0â€¿0â€¿Â¯1â€¿0
# Starting with non-zero
3â€¿3â€¿2â€¿2 Ae bt.Fill 3â€¿0â€¿2â€¿0

pass +â†© 1 â‹„ â€¢Out "  PASS  Fill"

# â”€â”€ Thresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿0â€¿1â€¿0â€¿0 Ae 30 bt.Thresh 25â€¿28â€¿35â€¿32â€¿29

pass +â†© 1 â‹„ â€¢Out "  PASS  Thresh"

# â”€â”€ ThreshDown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿0â€¿1â€¿0â€¿0 Ae 30 bt.ThreshDown 35â€¿32â€¿25â€¿28â€¿31

pass +â†© 1 â‹„ â€¢Out "  PASS  ThreshDown"

# â”€â”€ Hold â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿1â€¿1â€¿1â€¿0â€¿Â¯1 Ae 3 bt.Hold 0â€¿1â€¿0â€¿0â€¿0â€¿Â¯1
# No holding needed when already in position
1â€¿1â€¿1 Ae 2 bt.Hold 1â€¿1â€¿1

pass +â†© 1 â‹„ â€¢Out "  PASS  Hold"

# â•â• Simulation â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ _Sim â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Echo step: position = observation
result â† {âŸ¨ğ•©âŸ©} bt._Sim âŸ¨0âŸ©â€¿(1â€¿0â€¿1â€¿Â¯1â€¿0)
1â€¿0â€¿1â€¿Â¯1â€¿0 Ae result

# Accumulator step: state = âŸ¨sum, countâŸ©, position = running sum
result2 â† {âŸ¨(âŠ‘ğ•¨)+ğ•©, (1âŠ‘ğ•¨)+1âŸ©} bt._Sim âŸ¨0,0âŸ©â€¿(1â€¿2â€¿3)
1â€¿3â€¿6 Ae result2

pass +â†© 1 â‹„ â€¢Out "  PASS  _Sim"

# â•â• Backtest Core â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ Ret â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ret â† bt.Ret c
! 4 = â‰ ret
(0.02) As âŠ‘ret
# Second return: (101-102)/102
(Â¯1Ã·102) As 1âŠ‘ret

pass +â†© 1 â‹„ â€¢Out "  PASS  Ret"

# â”€â”€ LogRet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

lr â† bt.LogRet c
! 4 = â‰ lr
# LogRet â‰ˆ Ret for small returns
! âˆ§Â´ 0.001 > |lr - ret

pass +â†© 1 â‹„ â€¢Out "  PASS  LogRet"

# â”€â”€ Run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

sr â† 1â€¿0â€¿1â€¿Â¯1 bt.Run 0.02â€¿Â¯0.01â€¿0.03â€¿Â¯0.02
0.02â€¿0â€¿0.03â€¿0.02 Ae sr

pass +â†© 1 â‹„ â€¢Out "  PASS  Run"

# â”€â”€ Cost â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

costs â† 0.001 bt.Cost 0â€¿1â€¿1â€¿0â€¿Â¯1
0â€¿0.001â€¿0â€¿0.001â€¿0.001 Ae costs

pass +â†© 1 â‹„ â€¢Out "  PASS  Cost"

# â”€â”€ Equity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

eq â† bt.Equity 0.1â€¿Â¯0.05â€¿0.02
! 3 = â‰ eq
1.1 As âŠ‘eq
(1.1Ã—0.95) As 1âŠ‘eq
(1.1Ã—0.95Ã—1.02) As 2âŠ‘eq

pass +â†© 1 â‹„ â€¢Out "  PASS  Equity"

# â•â• Metrics â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Test returns for metrics
mr â† 0.02â€¿Â¯0.01â€¿0.03â€¿Â¯0.02â€¿0.01

# â”€â”€ TotalRet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tr â† bt.TotalRet mr
eq_final â† Â¯1âŠ‘bt.Equity mr
(eq_final - 1) As tr

pass +â†© 1 â‹„ â€¢Out "  PASS  TotalRet"

# â”€â”€ CAGR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cagr â† bt.CAGR mr
! cagr > 0  # net positive returns â†’ positive CAGR

pass +â†© 1 â‹„ â€¢Out "  PASS  CAGR"

# â”€â”€ AnnVol â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

vol â† bt.AnnVol mr
! vol > 0

pass +â†© 1 â‹„ â€¢Out "  PASS  AnnVol"

# â”€â”€ Sharpe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

sh â† bt.Sharpe mr
! sh > 0  # positive mean returns â†’ positive Sharpe
# Zero returns â†’ zero Sharpe
0 As bt.Sharpe 0â€¿0â€¿0â€¿0

pass +â†© 1 â‹„ â€¢Out "  PASS  Sharpe"

# â”€â”€ Sortino â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

so â† bt.Sortino mr
! so > 0
# Sortino â‰¥ Sharpe when there's downside
! so â‰¥ sh

pass +â†© 1 â‹„ â€¢Out "  PASS  Sortino"

# â”€â”€ MaxDD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

dd â† bt.MaxDD mr
! dd â‰¤ 0  # drawdown is non-positive
# All positive returns â†’ zero drawdown
0 As bt.MaxDD 0.01â€¿0.02â€¿0.03

pass +â†© 1 â‹„ â€¢Out "  PASS  MaxDD"

# â”€â”€ MaxDDDur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

dur â† bt.MaxDDDur mr
! dur â‰¥ 0
# All positive returns â†’ zero duration
0 As bt.MaxDDDur 0.01â€¿0.02â€¿0.03
# Single drawdown bar
1 As bt.MaxDDDur 0.1â€¿Â¯0.05â€¿0.1

pass +â†© 1 â‹„ â€¢Out "  PASS  MaxDDDur"

# â”€â”€ Calmar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cal â† bt.Calmar mr
! cal > 0

pass +â†© 1 â‹„ â€¢Out "  PASS  Calmar"

# â”€â”€ WinRate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

wr â† bt.WinRate mr
(3Ã·5) As wr  # 3 positive out of 5

pass +â†© 1 â‹„ â€¢Out "  PASS  WinRate"

# â”€â”€ ProfitFactor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

pf â† bt.ProfitFactor mr
# gross profit = 0.02+0.03+0.01 = 0.06, gross loss = 0.01+0.02 = 0.03
(0.06Ã·0.03) As pf

pass +â†© 1 â‹„ â€¢Out "  PASS  ProfitFactor"

# â”€â”€ AvgWin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

aw â† bt.AvgWin mr
((0.02+0.03+0.01)Ã·3) As aw

pass +â†© 1 â‹„ â€¢Out "  PASS  AvgWin"

# â”€â”€ AvgLoss â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

al â† bt.AvgLoss mr
((Â¯0.01+Â¯0.02)Ã·2) As al

pass +â†© 1 â‹„ â€¢Out "  PASS  AvgLoss"

# â”€â”€ Expectancy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ex â† bt.Expectancy mr
# mean of non-zero returns: (0.02-0.01+0.03-0.02+0.01)/5 = 0.006
0.006 As ex

pass +â†© 1 â‹„ â€¢Out "  PASS  Expectancy"

# â”€â”€ Trades â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

pos_t â† 0â€¿1â€¿1â€¿0â€¿Â¯1
3 As bt.Trades pos_t

pass +â†© 1 â‹„ â€¢Out "  PASS  Trades"

# â”€â”€ TimeIn / Exposure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

(3Ã·5) As bt.TimeIn pos_t
(bt.TimeIn pos_t) As bt.Exposure pos_t

pass +â†© 1 â‹„ â€¢Out "  PASS  TimeIn/Exposure"

# â”€â”€ Skew â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Symmetric distribution â†’ skew = 0
0 As bt.Skew 1â€¿2â€¿3â€¿4â€¿5

pass +â†© 1 â‹„ â€¢Out "  PASS  Skew"

# â”€â”€ Kurt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Uniform-like â†’ negative excess kurtosis
kurt â† bt.Kurt 1â€¿2â€¿3â€¿4â€¿5
Â¯1.3 As kurt

pass +â†© 1 â‹„ â€¢Out "  PASS  Kurt"

# â•â• Portfolio â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ PortRun â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# 2 assets, equal weights, known returns
pr â† 0.5â€¿0.5 bt.PortRun âŸ¨âŸ¨1â€¿1â€¿1â€¿1, 0.02â€¿Â¯0.01â€¿0.03â€¿Â¯0.02âŸ©, âŸ¨1â€¿1â€¿1â€¿1, 0.01â€¿0.02â€¿Â¯0.01â€¿0.04âŸ©âŸ©
# Expected: 0.5Ã—0.02+0.5Ã—0.01, 0.5Ã—(Â¯0.01)+0.5Ã—0.02, ...
0.015â€¿0.005â€¿0.01â€¿0.01 Ae pr

pass +â†© 1 â‹„ â€¢Out "  PASS  PortRun"

# â”€â”€ PortRun weights assertion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

! 1 = ({ğ•© bt.PortRun âŸ¨âŸ¨1â€¿1, 0.01â€¿0.02âŸ©, âŸ¨1â€¿1, 0.03â€¿0.04âŸ©âŸ© â‹„ 0}âŠ{1}) 0.3â€¿0.3

pass +â†© 1 â‹„ â€¢Out "  PASS  PortRun weight assertion"

# â”€â”€ PortCost â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

pc â† 0.001â€¿0.002 bt.PortCost âŸ¨0â€¿1â€¿1â€¿0, 0â€¿0â€¿1â€¿Â¯1âŸ©
# Asset 0: 0.001Ã—|0,1,0,1| = 0,0.001,0,0.001
# Asset 1: 0.002Ã—|0,0,1,2| = 0,0,0.002,0.004
# Combined: 0, 0.001, 0.002, 0.005
0â€¿0.001â€¿0.002â€¿0.005 Ae pc

pass +â†© 1 â‹„ â€¢Out "  PASS  PortCost"

# â”€â”€ PortEquity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

peq â† bt.PortEquity 0.1â€¿Â¯0.05â€¿0.02
eq_ref â† bt.Equity 0.1â€¿Â¯0.05â€¿0.02
peq Ae eq_ref

pass +â†© 1 â‹„ â€¢Out "  PASS  PortEquity"

# â•â• Walk-Forward â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

wf â† â€¢Import "../engine/wf.bqn"

# â”€â”€ Windows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# 10 bars, train=4, test=2 â†’ 3 folds
wins â† 4â€¿2 wf.Windows â†•10
! 3 = â‰ wins

# Fold 0: train=[0..3], test=[4..5]
0â€¿1â€¿2â€¿3 Ae âŠ‘âŠ‘wins
4â€¿5 Ae 1âŠ‘âŠ‘wins

# Fold 1: train=[2..5], test=[6..7]
2â€¿3â€¿4â€¿5 Ae âŠ‘1âŠ‘wins
6â€¿7 Ae 1âŠ‘1âŠ‘wins

# Fold 2: train=[4..7], test=[8..9]
4â€¿5â€¿6â€¿7 Ae âŠ‘2âŠ‘wins
8â€¿9 Ae 1âŠ‘2âŠ‘wins

pass +â†© 1 â‹„ â€¢Out "  PASS  Windows"

# â”€â”€ Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# 2 ranges â†’ 9 combos
g â† wf.Grid âŸ¨10â€¿20â€¿30, 40â€¿50â€¿60âŸ©
! 9 = â‰ g
# First tuple
10â€¿40 Ae âŠ‘g
# Last tuple
30â€¿60 Ae Â¯1âŠ‘g

pass +â†© 1 â‹„ â€¢Out "  PASS  Grid (2 ranges)"

# Single range
g1 â† wf.Grid âŸ¨1â€¿2â€¿3âŸ©
! 3 = â‰ g1
âŸ¨1âŸ© Ae âŠ‘g1
âŸ¨3âŸ© Ae Â¯1âŠ‘g1

pass +â†© 1 â‹„ â€¢Out "  PASS  Grid (1 range)"

# Three ranges
g3 â† wf.Grid âŸ¨1â€¿2, 3â€¿4, 5â€¿6âŸ©
! 8 = â‰ g3
1â€¿3â€¿5 Ae âŠ‘g3
2â€¿4â€¿6 Ae Â¯1âŠ‘g3

pass +â†© 1 â‹„ â€¢Out "  PASS  Grid (3 ranges)"

# â”€â”€ _WF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Trivial always-long strategy on synthetic data
# 20 bars of steadily rising prices
synth â† 100+â†•20

# Strategy: ignore params, go long always
AlwaysLong â† {ğ•¨ â‹„ (â‰ ğ•©)â¥Š1}

wf_result â† synth AlwaysLong wf._WF âŸ¨6, 2, âŸ¨âŸ¨1âŸ©âŸ©, 0, wf.SharpeâŸ©

# Verify fold count: 20 bars, train=6, test=2 â†’ nf = 1+âŒŠ(20-6-2)Ã·2 = 1+6 = 7
! 7 = â‰ wf_result.folds

# OOS return length: 7 folds Ã— (2-1) = 7 test returns (Ret shortens by 1)
! 7 = â‰ wf_result.oos_ret

# Equity curve same length as OOS returns
! (â‰ wf_result.oos_ret) = â‰ wf_result.oos_eq

# Summary metrics are finite
! Â¬ âˆ = |wf_result.summary.sharpe
! Â¬ âˆ = |wf_result.summary.maxdd

pass +â†© 1 â‹„ â€¢Out "  PASS  _WF"

# Look-ahead bias detection: momentum on oscillating data
# With look-ahead, strategy sees each return's sign before trading â†’ all positive OOS
# Without look-ahead, directional reversals produce negative OOS returns
MomStrat â† {ğ•¨ â‹„ 1âŒˆÂ¯1âŒŠ Ã—ğ•©-Â»ğ•©}
synth_la â† 100â€¿102â€¿99â€¿104â€¿97â€¿101â€¿98â€¿103â€¿100â€¿105â€¿96â€¿102â€¿99â€¿104â€¿97â€¿101â€¿98â€¿103â€¿100â€¿105
wf_la â† synth_la MomStrat wf._WF âŸ¨6, 3, âŸ¨âŸ¨1âŸ©âŸ©, 0, wf.SharpeâŸ©
! âˆ¨Â´ wf_la.oos_ret < 0
pass +â†© 1 â‹„ â€¢Out "  PASS  _WF no look-ahead bias"

# â•â• Composition â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cmp â† â€¢Import "../engine/cmp.bqn"

# â”€â”€ Norm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

n â† cmp.Norm 2â€¿4â€¿6â€¿8â€¿10
# d=Â¯4â€¿Â¯2â€¿0â€¿2â€¿4, std=âˆš8
(Â¯4â€¿Â¯2â€¿0â€¿2â€¿4 Ã· âˆš8) Ae n

pass +â†© 1 â‹„ â€¢Out "  PASS  Norm"

# â”€â”€ ENorm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

en â† cmp.ENorm 2â€¿4â€¿6â€¿8â€¿10
# No lookahead: bar 0 has std=0 â†’ result 0
0 As âŠ‘en
# Each bar uses only past data, so values differ from full-array Norm
! 5 = â‰ en

pass +â†© 1 â‹„ â€¢Out "  PASS  ENorm"

# â”€â”€ Score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

sc â† 0.6â€¿0.4 cmp.Score âŸ¨1â€¿2â€¿3, 4â€¿5â€¿6âŸ©
2.2â€¿3.2â€¿4.2 Ae sc

pass +â†© 1 â‹„ â€¢Out "  PASS  Score"

# â”€â”€ Thresh (cmp) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1â€¿0â€¿Â¯1â€¿0â€¿1 Ae 0.5 cmp.Thresh 1â€¿0.3â€¿Â¯0.8â€¿0â€¿0.6

pass +â†© 1 â‹„ â€¢Out "  PASS  Thresh (cmp)"

# â”€â”€ Compose â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cpos â† âŸ¨0.5â€¿0.5, 0.3âŸ© cmp.Compose âŸ¨1â€¿2â€¿3, 4â€¿5â€¿6âŸ©
! 3 = â‰ cpos
! âˆ§Â´ cposâˆŠ1â€¿0â€¿Â¯1

pass +â†© 1 â‹„ â€¢Out "  PASS  Compose"

# â”€â”€ Score auto-alignment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

sc2 â† 0.5â€¿0.5 cmp.Score âŸ¨1â€¿2â€¿3â€¿4â€¿5, 10â€¿20â€¿30âŸ©
! 3 = â‰ sc2

pass +â†© 1 â‹„ â€¢Out "  PASS  Score auto-alignment"

# â”€â”€ Compose single-feature â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

csf â† 2â€¿4â€¿6â€¿8â€¿10
(0.5 cmp.Thresh cmp.Norm csf) Ae âŸ¨1âŸ©â€¿0.5 cmp.Compose âŸ¨csfâŸ©

pass +â†© 1 â‹„ â€¢Out "  PASS  Compose single-feature"

# â•â• Edge Cases â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ Single element â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âŸ¨42âŸ© Ae 1 bt.MA âŸ¨42âŸ©
! 0 = â‰  2 bt.MA âŸ¨42âŸ©
âŸ¨42âŸ© Ae 3 bt.EMA âŸ¨42âŸ©
! 0 = â‰  2 bt.Std âŸ¨42âŸ©
! 0 = â‰  1 bt.Mom âŸ¨42âŸ©
! 0 = â‰  1 bt.ROC âŸ¨42âŸ©

pass +â†© 1 â‹„ â€¢Out "  PASS  Edge: single element"

# â”€â”€ Constant prices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cc â† 50â€¿50â€¿50â€¿50â€¿50
50â€¿50â€¿50â€¿50 Ae 2 bt.MA cc
50â€¿50â€¿50â€¿50â€¿50 Ae 2 bt.EMA cc
0â€¿0â€¿0â€¿0 Ae 2 bt.Std cc
0â€¿0â€¿0â€¿0 Ae 1 bt.Mom cc
0â€¿0â€¿0â€¿0 Ae 1 bt.ROC cc

pass +â†© 1 â‹„ â€¢Out "  PASS  Edge: constant prices"

# â”€â”€ Large price swings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

big â† 0.01â€¿10000â€¿0.01â€¿10000â€¿0.01
eq_big â† bt.Equity bt.Ret big
! âˆ§Â´ eq_big > 0
! âˆ§Â´ Â¬ âˆ = |eq_big

pass +â†© 1 â‹„ â€¢Out "  PASS  Edge: large swings"

# â”€â”€ Zero volume â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

zv â† {datesâ‡"a"â€¿"b"â€¿"c", closeâ‡100â€¿102â€¿101, highâ‡105â€¿107â€¿104, lowâ‡95â€¿99â€¿98, openâ‡98â€¿100â€¿102, volâ‡0â€¿0â€¿0}
0â€¿0â€¿0 Ae bt.OBV zv.closeâ€¿zv.vol
vwap_zv â† bt.VWAP zv
! 3 = â‰ vwap_zv
! âˆ§Â´ Â¬ âˆ = |vwap_zv

pass +â†© 1 â‹„ â€¢Out "  PASS  Edge: zero volume"

# â”€â”€ All-long / all-short / all-flat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

er â† 0.02â€¿Â¯0.01â€¿0.03â€¿Â¯0.02
0.02â€¿Â¯0.01â€¿0.03â€¿Â¯0.02 Ae (4â¥Š1) bt.Run er
Â¯0.02â€¿0.01â€¿Â¯0.03â€¿0.02 Ae (4â¥ŠÂ¯1) bt.Run er
0â€¿0â€¿0â€¿0 Ae (4â¥Š0) bt.Run er

pass +â†© 1 â‹„ â€¢Out "  PASS  Edge: all-long/short/flat"

# â”€â”€ Single trade â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0â€¿0.05â€¿0 Ae (0â€¿1â€¿0) bt.Run 0.02â€¿0.05â€¿Â¯0.02
2 As bt.Trades 0â€¿1â€¿0

pass +â†© 1 â‹„ â€¢Out "  PASS  Edge: single trade"

# â•â• Property Tests â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Random OHLCV generator: sorts 4 random values per bar to get valid lowâ‰¤openâ‰¤closeâ‰¤high
GenOHLCV â† {
  r â† 1 + (4Ã—ğ•©) â€¢rand.Range 100
  s â† â‰ âˆ§Ë˜ (ğ•©â€¿4) â¥Š r
  lowâ†0âŠs â‹„ openâ†1âŠs â‹„ closeâ†2âŠs â‹„ highâ†3âŠs
  vol â† 1 + ğ•© â€¢rand.Range 10000
  dates â† â€¢FmtÂ¨ â†•ğ•©
  {datesâ‡dates, closeâ‡close, highâ‡high, lowâ‡low, openâ‡open, volâ‡vol}
}

# â”€â”€ MA/EMA/WMA bounded â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  d â† GenOHLCV 50 â‹„ c â† d.close
  lo â† âŒŠÂ´c â‹„ hi â† âŒˆÂ´c
  ma â† 5 bt.MA c â‹„ ! âˆ§Â´ (maâ‰¥lo) âˆ§ maâ‰¤hi
  ema â† 5 bt.EMA c â‹„ ! âˆ§Â´ (emaâ‰¥lo) âˆ§ emaâ‰¤hi
  wma â† 5 bt.WMA c â‹„ ! âˆ§Â´ (wmaâ‰¥lo) âˆ§ wmaâ‰¤hi
  0
}Â¨ â†•10

pass +â†© 1 â‹„ â€¢Out "  PASS  Prop: MA/EMA/WMA bounded"

# â”€â”€ RSI/Stoch/BB ranges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  d â† GenOHLCV 50
  rsi â† 14 bt.RSI d.close
  ! âˆ§Â´ (rsiâ‰¥0) âˆ§ rsiâ‰¤100
  kâ€¿kd â† 5 bt.Stoch d
  ! âˆ§Â´ (kâ‰¥0) âˆ§ kâ‰¤100
  uâ€¿mâ€¿l â† 10â€¿2 bt.BB d.close
  ! âˆ§Â´ u â‰¥ m
  ! âˆ§Â´ m â‰¥ l
  0
}Â¨ â†•10

pass +â†© 1 â‹„ â€¢Out "  PASS  Prop: RSI/Stoch/BB ranges"

# â”€â”€ Metrics ranges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  d â† GenOHLCV 50
  r â† bt.Ret d.close
  dd â† bt.MaxDD r
  ! dd â‰¤ 0
  ! dd â‰¥ Â¯1
  wr â† bt.WinRate r
  ! wr â‰¥ 0
  ! wr â‰¤ 1
  ((Â¯1âŠ‘bt.Equity r) - 1) As bt.TotalRet r
  0
}Â¨ â†•10

pass +â†© 1 â‹„ â€¢Out "  PASS  Prop: MaxDD/WinRate/TotalRet"

# â”€â”€ Cross/CrossDown boolean â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  d â† GenOHLCV 50 â‹„ c â† d.close
  fâ€¿s â† bt.Align (5 bt.MA c)â€¿(10 bt.MA c)
  ! âˆ§Â´ (f bt.Cross s) âˆŠ 0â€¿1
  ! âˆ§Â´ (f bt.CrossDown s) âˆŠ 0â€¿1
  0
}Â¨ â†•10

pass +â†© 1 â‹„ â€¢Out "  PASS  Prop: Cross/CrossDown boolean"

# â”€â”€ Indicator output lengths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  d â† GenOHLCV 50 â‹„ c â† d.close â‹„ n â† â‰ c
  ! (n-4) = â‰  5 bt.MA c
  ! n = â‰  5 bt.EMA c
  ! (n-4) = â‰  5 bt.WMA c
  ! (n-4) = â‰  5 bt.Std c
  ! (n-1) = â‰  1 bt.Mom c
  ! (n-1) = â‰  1 bt.ROC c
  0
}Â¨ â†•10

pass +â†© 1 â‹„ â€¢Out "  PASS  Prop: indicator lengths"

# â”€â”€ Cost non-negative â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  pos â† (50 â€¢rand.Range 3) - 1
  costs â† 0.001 bt.Cost pos
  ! âˆ§Â´ costs â‰¥ 0
  0
}Â¨ â†•10

pass +â†© 1 â‹„ â€¢Out "  PASS  Prop: Cost non-negative"

# â”€â”€ Equity positive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  d â† GenOHLCV 50
  r â† bt.Ret d.close
  eq â† bt.Equity r
  ! âˆ§Â´ eq > 0
  (1+âŠ‘r) As âŠ‘eq
  0
}Â¨ â†•10

pass +â†© 1 â‹„ â€¢Out "  PASS  Prop: Equity positive"

# â”€â”€ Mask zeroes prefix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  n â† 1 + â€¢rand.Range 9
  arr â† 1 + 20 â€¢rand.Range 100
  m â† n bt.Mask arr
  ! âˆ§Â´ 0 = nâ†‘m
  ! 20 = â‰ m
  0
}Â¨ â†•10

pass +â†© 1 â‹„ â€¢Out "  PASS  Prop: Mask zeroes prefix"

# â•â• Options Pricing â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

opt â† â€¢Import "../engine/opt.bqn"

# â”€â”€ Npdf â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Npdf(0) â‰ˆ 1/âˆš(2Ï€) â‰ˆ 0.398942
(0.398942) As opt.Npdf 0
# Symmetry: Npdf(x) = Npdf(-x)
(opt.Npdf 1.5) As opt.Npdf Â¯1.5
# Array compat
! 3 = â‰  opt.Npdf 0â€¿1â€¿2

pass +â†© 1 â‹„ â€¢Out "  PASS  Npdf"

# â”€â”€ Phi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Known values
0.5 As opt.Phi 0
(0.841345) As opt.Phi 1
(0.158655) As opt.Phi Â¯1
(0.977250) As opt.Phi 2
# Symmetry: Phi(x) + Phi(-x) = 1
1 As (opt.Phi 1.5) + opt.Phi Â¯1.5
# Array compat
! 4 = â‰  opt.Phi 0â€¿1â€¿Â¯1â€¿2

pass +â†© 1 â‹„ â€¢Out "  PASS  Phi"

# â”€â”€ BS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Hull ch13: S=42, K=40, T=0.5, r=0.1, Ïƒ=0.2
# Call â‰ˆ 4.76, Put â‰ˆ 0.81
bsc â† opt.BS 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿1
! 0.01 > |bsc - 4.76
bsp â† opt.BS 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿Â¯1
! 0.01 > |bsp - 0.81

# Monotonicity: call price decreases with higher strikes
c35 â† opt.BS 42â€¿35â€¿0.5â€¿0.1â€¿0.2â€¿1
c45 â† opt.BS 42â€¿45â€¿0.5â€¿0.1â€¿0.2â€¿1
c50 â† opt.BS 42â€¿50â€¿0.5â€¿0.1â€¿0.2â€¿1
! c35 > c45
! c45 > c50

pass +â†© 1 â‹„ â€¢Out "  PASS  BS"

# â”€â”€ Parity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Put-call parity: call - put = S - Ke^(-rT)
par â† opt.Parity 42â€¿40â€¿0.5â€¿0.1
(bsc - bsp) As par

pass +â†© 1 â‹„ â€¢Out "  PASS  Parity"

# â”€â”€ Delta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

dc â† opt.Delta 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿1
dp â† opt.Delta 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿Â¯1
# Call delta âˆˆ [0,1], put delta âˆˆ [-1,0]
! (dcâ‰¥0) âˆ§ dcâ‰¤1
! (dpâ‰¥Â¯1) âˆ§ dpâ‰¤0
# Call delta - put delta = 1
1 As dc - dp

pass +â†© 1 â‹„ â€¢Out "  PASS  Delta"

# â”€â”€ Gamma â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

gc â† opt.Gamma 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿1
gp â† opt.Gamma 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿Â¯1
# Same for call/put, positive
gc As gp
! gc > 0

pass +â†© 1 â‹„ â€¢Out "  PASS  Gamma"

# â”€â”€ Vega â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

vc â† opt.Vega 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿1
vp â† opt.Vega 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿Â¯1
# Same for call/put, positive
vc As vp
! vc > 0

pass +â†© 1 â‹„ â€¢Out "  PASS  Vega"

# â”€â”€ Theta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tc â† opt.Theta 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿1
tp â† opt.Theta 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿Â¯1
# Time decay: theta is negative for long options
! tc < 0

pass +â†© 1 â‹„ â€¢Out "  PASS  Theta"

# â”€â”€ Rho â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

rc â† opt.Rho 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿1
rp â† opt.Rho 42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿Â¯1
# Call rho > 0, put rho < 0
! rc > 0
! rp < 0

pass +â†© 1 â‹„ â€¢Out "  PASS  Rho"

# â”€â”€ IV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Round-trip: price â†’ IV â†’ price across 6 scenarios
{
  sâ€¿kâ€¿ttâ€¿râ€¿vâ€¿ty â† ğ•©
  price â† opt.BS ğ•©
  iv â† opt.IV priceâ€¿sâ€¿kâ€¿ttâ€¿râ€¿ty
  reprice â† opt.BS sâ€¿kâ€¿ttâ€¿râ€¿ivâ€¿ty
  ! 1eÂ¯4 > |price - reprice
  0
}Â¨ âŸ¨
  42â€¿40â€¿0.5â€¿0.1â€¿0.2â€¿1     # ITM call, low vol
, 42â€¿45â€¿0.5â€¿0.1â€¿0.2â€¿Â¯1    # ITM put, low vol
, 42â€¿50â€¿0.5â€¿0.1â€¿0.4â€¿1     # OTM call, high vol
, 42â€¿35â€¿0.5â€¿0.1â€¿0.4â€¿Â¯1    # OTM put, high vol
, 42â€¿42â€¿0.5â€¿0.1â€¿0.3â€¿1     # ATM call
, 42â€¿42â€¿0.5â€¿0.1â€¿0.3â€¿Â¯1    # ATM put
âŸ©

pass +â†© 1 â‹„ â€¢Out "  PASS  IV"

# â•â• Monte Carlo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

mc â† â€¢Import "../engine/mc.bqn"

# â”€â”€ Paths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

paths â† mc.Paths 100â€¿100â€¿0.05â€¿0.2â€¿1â€¿252
! 100 = âŠ‘ â‰¢paths                  # 100 paths
! 252 = 1âŠ‘ â‰¢paths                 # 252 steps
! âˆ§Â´ âˆ§Ë paths > 0                 # GBM paths always positive

pass +â†© 1 â‹„ â€¢Out "  PASS  MC Paths"

# â”€â”€ _Antithetic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

apaths â† mc.Paths mc._Antithetic 50â€¿100â€¿0.05â€¿0.2â€¿1â€¿252
! 100 = âŠ‘ â‰¢apaths                 # 2Ã—50 = 100 paths
! 252 = 1âŠ‘ â‰¢apaths
! âˆ§Â´ âˆ§Ë apaths > 0

pass +â†© 1 â‹„ â€¢Out "  PASS  MC _Antithetic"

# â”€â”€ Payoffs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# EuroCall: max(S_T - K, 0)
! 0 = 100 mc.EuroCall 90â€¿95â€¿80     # OTM: S_T=80 < K=100
! 10 = 100 mc.EuroCall 90â€¿95â€¿110   # ITM: 110-100 = 10

# EuroPut: max(K - S_T, 0)
! 20 = 100 mc.EuroPut 90â€¿95â€¿80     # ITM: 100-80 = 20
! 0 = 100 mc.EuroPut 90â€¿95â€¿110     # OTM: S_T=110 > K=100

# AsianCall: max(avg - K, 0)
! 0 = 100 mc.AsianCall 90â€¿110â€¿80   # avg=93.33 < 100
! (110 mc.AsianCall 100â€¿120â€¿130) > 0

# BarrierUpOut: knocked out if any price >= barrier
! 0 = 100â€¿120 mc.BarrierUpOut 90â€¿130â€¿110   # breached: 130 >= 120
! (100â€¿120 mc.BarrierUpOut 90â€¿110â€¿115) > 0  # not breached, ITM

pass +â†© 1 â‹„ â€¢Out "  PASS  MC Payoffs"

# â”€â”€ _Price convergence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# MC European call should converge to BS within tolerance
{
  s0â†100 â‹„ kâ†100 â‹„ râ†0.05 â‹„ sigâ†0.2 â‹„ tâ†1
  bsPrice â† opt.BS s0â€¿kâ€¿tâ€¿râ€¿sigâ€¿1
  paths â† mc.Paths 50000â€¿s0â€¿râ€¿sigâ€¿tâ€¿252
  mcPrice â† kâŠ¸mc.EuroCall mc._Price pathsâ€¿râ€¿t
  ! 0.5 > |mcPrice - bsPrice
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  MC _Price convergence"

# â•â• Risk â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

risk â† â€¢Import "../engine/risk.bqn"

# â”€â”€ VolTarget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Result has same length as input signal
{
  ret â† 0.01â€¿0.02â€¿Â¯0.01â€¿0.005â€¿Â¯0.005â€¿0.015â€¿Â¯0.008â€¿0.003â€¿0.01â€¿Â¯0.02â€¿0.005â€¿0.008â€¿Â¯0.003â€¿0.012â€¿Â¯0.007â€¿0.001â€¿0.009â€¿Â¯0.004â€¿0.006â€¿0.002â€¿0.011â€¿Â¯0.003â€¿0.007â€¿0.002â€¿0.01
  sig â† (â‰ ret) â¥Š 1
  vt â† 0.20 risk.VolTarget sigâ€¿ret
  ! (â‰ vt) = â‰ sig
  # First n-1 bars are 0 (warmup, no vol estimate yet)
  ! âˆ§Â´ 0 = 20â†‘vt
  ! (20âŠ‘vt) > 0
  # After warmup, values are finite and positive (sig=1, target>0)
  ! âˆ§Â´ (21â†“vt) > 0
  ! âˆ§Â´ Â¬ âˆ = |vt
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  VolTarget"

# â”€â”€ KellyFrac: zero-mean â†’ 0, negative-mean â†’ negative â”€â”€

{
  ret â† âŸ¨0,0,0,0,0âŸ©
  k â† 0.5 risk.KellyFrac ret
  ! 0 = k

  ret2 â† Â¯0.01â€¿Â¯0.01â€¿Â¯0.01â€¿Â¯0.01â€¿Â¯0.01
  k2 â† 0.5 risk.KellyFrac ret2
  ! k2 < 0
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  KellyFrac (zero/negative)"

# â”€â”€ KellyFrac: clipped to [Â¯1,1] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  # Extreme positive: huge mean/var ratio â†’ clipped to 1
  ret â† 0.5â€¿0.5â€¿0.5â€¿0.5â€¿0.5001
  k â† 1 risk.KellyFrac ret
  1 As k

  # Extreme negative: clipped to Â¯1
  ret2 â† Â¯0.5â€¿Â¯0.5â€¿Â¯0.5â€¿Â¯0.5â€¿Â¯0.5001
  k2 â† 1 risk.KellyFrac ret2
  Â¯1 As k2
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  KellyFrac (clipping)"

# â”€â”€ KellySeries: length matches input â”€â”€â”€â”€â”€â”€â”€â”€

{
  ret â† 0.01â€¿0.02â€¿Â¯0.01â€¿0.005â€¿Â¯0.005â€¿0.015â€¿Â¯0.008â€¿0.003â€¿0.01â€¿Â¯0.02
  sig â† (â‰ ret) â¥Š 1
  ks â† 5â€¿0.5 risk.KellySeries sigâ€¿ret
  ! (â‰ ks) = â‰ ret
  # First n bars are zero (not enough data)
  ! âˆ§Â´ 0 = 5â†‘ks
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  KellySeries"

# â”€â”€ MaxPos: magnitudes â‰¤ cap, signs preserved â”€

{
  pos â† âŸ¨Â¯2,Â¯0.5,0,0.5,2âŸ©
  capped â† 1 risk.MaxPos pos
  ! âˆ§Â´ (|capped) â‰¤ 1
  ! 0 = 2âŠ‘capped
  ! (0âŠ‘capped) < 0
  ! (3âŠ‘capped) > 0
  # Small positions unchanged
  (Â¯0.5) As 1âŠ‘capped
  (0.5) As 3âŠ‘capped
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  MaxPos"

# â”€â”€ CircuitBreaker: fires and persists â”€â”€â”€â”€â”€â”€â”€

{
  # Construct returns where bars 1-3 have cumulative < Â¯0.10
  ret â† 0.01â€¿Â¯0.05â€¿Â¯0.04â€¿Â¯0.03â€¿0.02â€¿0.01â€¿0.03â€¿Â¯0.01â€¿0.02â€¿0.01
  pos â† (â‰ ret) â¥Š 1
  cb â† 3â€¿(Â¯0.10) risk.CircuitBreaker posâ€¿ret
  ! (â‰ cb) = â‰ ret
  # Should have zeros where breaker fires
  ! âˆ¨Â´ cb = 0
  # Unaffected bars should be 1
  ! âˆ¨Â´ cb = 1
  # First bar never fires (not enough history)
  ! 1 = âŠ‘cb
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  CircuitBreaker"

# â”€â”€ DDControl: zeros during drawdown, resumes â”€

{
  # Sharp loss then recovery
  ret â† 0.01â€¿Â¯0.08â€¿Â¯0.03â€¿0.02â€¿0.05â€¿0.06â€¿0.04â€¿0.03â€¿0.02â€¿0.01
  pos â† (â‰ ret) â¥Š 1
  ddc â† Â¯0.05 risk.DDControl posâ€¿ret
  ! (â‰ ddc) = â‰ ret
  # First bar: no drawdown â†’ active
  ! 1 = âŠ‘ddc
  # After big loss: should be zeroed
  ! 0 = 1âŠ‘ddc
  # Eventually recovers (last bars should be 1 after recovery)
  ! 1 = Â¯1âŠ‘ddc
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  DDControl"

# â•â• Overfitting Metrics â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ovf â† â€¢Import "../engine/ovf.bqn"

# â”€â”€ PhiInv â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  ps â† 0.05â€¿0.1â€¿0.3â€¿0.5â€¿0.7â€¿0.9â€¿0.95
  { pâ†ğ•© â‹„ ! 1eÂ¯5 > |p - opt.Phi opt.PhiInv p }Â¨ ps
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  PhiInv round-trip"

# â”€â”€ DSR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# High SR, n=1, long T â†’ near 1
{
  d â† 1 ovf.DSR 3.0â€¿0.0â€¿0.0â€¿1000
  ! d > 0.99
  0
}

# Low SR, many trials â†’ small
{
  d â† 1000 ovf.DSR 0.1â€¿0.0â€¿0.0â€¿252
  ! d < 0.1
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  DSR"

# â”€â”€ PSR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# SR well above bench with long T â†’ high
{
  p â† 0 ovf.PSR 0.3â€¿50â€¿1â€¿0.0â€¿0.0
  ! p > 0.9
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  PSR"

# â”€â”€ HHI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  # Single positive bar â†’ HHI = 1
  1 As ovf.HHI âŸ¨0.01, Â¯0.01, Â¯0.01, Â¯0.01âŸ©

  # Three equal â†’ HHI = 1/3
  (1Ã·3) As ovf.HHI âŸ¨0.01, 0.01, 0.01âŸ©
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  HHI"

# â”€â”€ TrialCorrect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  pvals â† âŸ¨0.001, 0.01, 0.05, 0.1, 0.3âŸ©
  rej â† 5â€¿0.05 ovf.TrialCorrect pvals
  ! 1 = 0âŠ‘rej    # p=0.001 rejected
  ! 1 = 1âŠ‘rej    # p=0.01 rejected
  ! 0 = 2âŠ‘rej    # p=0.05 not rejected
  ! 0 = 4âŠ‘rej    # p=0.3 not rejected
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  TrialCorrect"

# â”€â”€ MinTRL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  # Known: MinTRL(n=1, SR=1.0, sk=0, ku=0) â‰ˆ 3.029
  m â† 1â€¿1.0 ovf.MinTRL 0.0â€¿0.0
  ! 0.1 > |m - 3.029
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  MinTRL"

# â•â• Exec â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

exec â† â€¢Import "../engine/exec.bqn"

# â”€â”€ Slippage: zero change â†’ zero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  pos â† 1â€¿1â€¿1â€¿1â€¿1
  vol â† 1e6â€¿1e6â€¿1e6â€¿1e6â€¿1e6
  sl â† 0.1â€¿0.1 exec.Slippage posâ€¿vol
  ! 0 < âŠ‘sl         # first bar: change from 0 to 1
  ! âˆ§Â´ 0 = 1â†“sl     # no further changes
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  Slippage"

# â”€â”€ FillLimit: clips to cap, preserves sign â”€â”€

{
  pos â† Â¯2â€¿Â¯0.5â€¿0â€¿0.5â€¿2
  vol â† 1e4â€¿1e4â€¿1e4â€¿1e4â€¿1e4
  fl â† 0.0001 exec.FillLimit posâ€¿vol  # cap = 1
  ! âˆ§Â´ (|fl) â‰¤ 1
  ! 0 = 2âŠ‘fl
  ! (0âŠ‘fl) < 0
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  FillLimit"

# â”€â”€ RunOHLC: length = â‰ pos - 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  d â† GenOHLCV 20
  pos â† (â‰ d.close) â¥Š 1
  r â† pos bt.RunOHLC d
  ! (â‰ r) = (â‰ pos)-1
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  RunOHLC"

# â”€â”€ StopLoss fires correctly â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  open_v â† 100â€¿100â€¿100â€¿100â€¿100
  high_v â† 101â€¿101â€¿101â€¿101â€¿101
  low_v  â† 99â€¿99â€¿90â€¿99â€¿99
  close_vâ† 100â€¿100â€¿100â€¿100â€¿100
  vol_v  â† 1e6â€¿1e6â€¿1e6â€¿1e6â€¿1e6
  d â† {datesâ‡â€¢FmtÂ¨â†•5, openâ‡open_v, highâ‡high_v, lowâ‡low_v, closeâ‡close_v, volâ‡vol_v}
  pos â† 0â€¿1â€¿1â€¿1â€¿1
  r â† 0.02 exec.StopLoss posâ€¿d
  # bar 1: enter long, entry_px = open[1]=100, stop=98
  # bar 2: low[2]=90 < 98 â†’ trigger
  ! 1 = 2âŠ‘r.triggered
  ! 0 = 2âŠ‘r.pos
  # stop ret = (98-100)/100 = -0.02
  (Â¯0.02) As 2âŠ‘r.ret
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  StopLoss"

# â”€â”€ StopTake: stop wins on same-bar conflict â”€

{
  open_v â† 100â€¿100
  high_v â† 100â€¿115
  low_v  â† 100â€¿85
  close_vâ† 100â€¿100
  vol_v  â† 1e6â€¿1e6
  d â† {datesâ‡â€¢FmtÂ¨â†•2, openâ‡open_v, highâ‡high_v, lowâ‡low_v, closeâ‡close_v, volâ‡vol_v}
  pos â† 1â€¿1
  r â† 0.05â€¿0.10 exec.StopTake posâ€¿d
  # bar 0: entry at 100, stop=95, tp=110
  # bar 1: low=85<95 (stop) and high=115>110 (tp), stop wins
  ! 0 < 1âŠ‘r.triggered
  # fill at stop=95, return = (95-100)/100 = -0.05
  (Â¯0.05) As 1âŠ‘r.ret
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  StopTake"

# â”€â”€ Slippage â†’ 0 for huge volume â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  pos â† âŸ¨0, 1, 1, 0, 1âŸ©
  vol â† (â‰ pos) â¥Š 1e15
  sl â† 0.1â€¿0.1 exec.Slippage posâ€¿vol
  ! âˆ§Â´ sl < 1eÂ¯5
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  Slippage (huge volume)"

# â•â• Universe â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

uni â† â€¢Import "../engine/uni.bqn"

# Helper: synthetic OHLCV namespace of length n, starting at base
MkNs â† {
  nâ€¿base â† ğ•©
  prices â† base+â†•n
  {datesâ‡â€¢FmtÂ¨â†•n, closeâ‡prices, highâ‡prices+1, lowâ‡prices-1, openâ‡prices+0.5, volâ‡1000â¥ŠËœn}
}

# â”€â”€ Universe shape â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  ns â† MkNsÂ¨ âŸ¨10â€¿100, 10â€¿200, 10â€¿300âŸ©
  u â† uni.Universe ns
  ! 10 = u.n_bars
  ! 3 = u.n_assets
  ! (10â€¿3) â‰¡ â‰¢u.close
  ! (10â€¿3) â‰¡ â‰¢u.high
  ! (10â€¿3) â‰¡ â‰¢u.low
  ! (10â€¿3) â‰¡ â‰¢u.open
  ! (10â€¿3) â‰¡ â‰¢u.vol
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  Universe shape"

# â”€â”€ XRank â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  mat â† 3â€¿4â¥Š12â€¿3â€¿7â€¿1â€¿ 5â€¿9â€¿2â€¿8â€¿ 4â€¿11â€¿6â€¿10
  ranked â† uni.XRank mat
  # Each row is a valid permutation of 0..3
  ! âˆ§Â´ {(âˆ§ğ•©)â‰¡â†•4}Ë˜ ranked
  # Row 0: 1 is smallest (rank 0), 3 is 2nd (rank 1), 7 is 3rd (rank 2), 12 is largest (rank 3)
  3â€¿1â€¿2â€¿0 Ae 0âŠranked
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  XRank"

# â”€â”€ XScore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  mat â† 3â€¿3â¥Š1â€¿2â€¿3â€¿ 4â€¿5â€¿6â€¿ 7â€¿8â€¿9
  scored â† uni.XScore mat
  # Row means should be 0
  ! âˆ§Â´ 1eÂ¯10 > |+ËË˜scored
  # Shape preserved
  ! (3â€¿3) â‰¡ â‰¢scored
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  XScore"

# â”€â”€ XWeight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  mat â† 3â€¿3â¥Š1â€¿Â¯2â€¿3â€¿ 4â€¿5â€¿Â¯6â€¿ 7â€¿8â€¿9
  w â† uni.XWeight mat
  # Abs row sums = 1
  ! âˆ§Â´ 1eÂ¯10 > |(+ËË˜|w)-1
  # Shape preserved
  ! (3â€¿3) â‰¡ â‰¢w
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  XWeight"

# â”€â”€ LongOnly â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  mat â† 3â€¿3â¥Š1â€¿Â¯2â€¿3â€¿ Â¯4â€¿5â€¿Â¯6â€¿ 0â€¿0â€¿0
  lo â† uni.LongOnly mat
  # All non-negative
  ! âˆ§Â´ âˆ§Ë loâ‰¥0
  # Positive rows sum to 1, zero row sums to 0
  sums â† +ËË˜lo
  ! 1eÂ¯10 > |1-0âŠ‘sums
  ! 1eÂ¯10 > |1-1âŠ‘sums
  ! 0 = 2âŠ‘sums
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  LongOnly"

# â”€â”€ TopN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  scores â† 3â€¿4â¥Š12â€¿3â€¿7â€¿1â€¿ 5â€¿9â€¿2â€¿8â€¿ 4â€¿11â€¿6â€¿10
  tn â† 1 uni.TopN scores
  # Each row: exactly 1 positive (1/n) and 1 negative (-1/n)
  ! âˆ§Â´ {1 = +Â´ğ•©>0}Ë˜ tn
  ! âˆ§Â´ {1 = +Â´ğ•©<0}Ë˜ tn
  # Row sums = 0 (long-short balanced)
  ! âˆ§Â´ 1eÂ¯10 > |+ËË˜tn
  # Magnitudes = 1/n = 1
  ! âˆ§Â´ âˆ§Ë (tn=1)âˆ¨(tn=Â¯1)âˆ¨(tn=0)
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  TopN"

# â”€â”€ _UniRun â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  ns â† MkNsÂ¨ âŸ¨10â€¿100, 10â€¿200, 10â€¿300âŸ©
  u â† uni.Universe ns
  AlwaysLong â† {(â‰ ğ•©)â¥Š1}
  pos â† AlwaysLong uni._UniRun u
  ! (10â€¿3) â‰¡ â‰¢pos
  ! âˆ§Â´ âˆ§Ë pos=1
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  _UniRun"

# â”€â”€ AlignDates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  a â† MkNs 10â€¿100
  b â† MkNs 7â€¿200
  c â† MkNs 15â€¿300
  aligned â† bt.AlignDates âŸ¨a, b, câŸ©
  ! 3 = â‰ aligned
  # All trimmed to shortest (7)
  ! 7 = â‰ (0âŠ‘aligned).close
  ! 7 = â‰ (1âŠ‘aligned).close
  ! 7 = â‰ (2âŠ‘aligned).close
  # Tail-aligned: last element of a.close should be last element of aligned[0].close
  ! (Â¯1âŠ‘a.close) = Â¯1âŠ‘(0âŠ‘aligned).close
  0
}

pass +â†© 1 â‹„ â€¢Out "  PASS  AlignDates"

# â•â• Summary â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â€¢Out ""
â€¢Out "All " âˆ¾ (â€¢Fmt pass) âˆ¾ " tests passed"
